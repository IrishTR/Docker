########################### NETWORKS
networks:
  t3_proxy:
    name: t3_proxy
    driver: bridge
    ipam:
      config:
        - subnet: $TRAEFIK_NETWORK
  default:
    driver: bridge

# Common environment values
x-environment: &default-tz-puid-pgid
  TZ: $TZ
  PUID: $PUID
  PGID: $PGID

# Keys common to some of the services in basic-services.txt
x-common-keys-core: &common-keys-core
  networks:
    - t3_proxy
  security_opt:
    - no-new-privileges:true
  restart: always

# Keys common to some of the dependent services/apps
x-common-keys-apps: &common-keys-apps
  networks:
    - t3_proxy
  security_opt:
    - no-new-privileges:true
  restart: unless-stopped

# SECRETS
secrets:
  plex_claim:
    file: $DOCKERDIR/secrets/plex_claim
  plex_token:
    file: $DOCKERDIR/secrets/plex_token
  mysql_root_password:
    file: $DOCKERDIR/secrets/mysql_root_password
  teslamate_db_name:
    file: $DOCKERDIR/secrets/teslamate_db_name
  teslamate_db_user:
    file: $DOCKERDIR/secrets/teslamate_db_user
  teslamate_db_password:
    file: $DOCKERDIR/secrets/teslamate_db_password
  teslamate_ek:
    file: $DOCKERDIR/secrets/teslamate_ek
  transmission_rpc_username:
    file: $DOCKERDIR/secrets/transmission_rpc_username
  transmission_rpc_password:
    file: $DOCKERDIR/secrets/transmission_rpc_password
  pia_username:
    file: $DOCKERDIR/secrets/pia_username
  pia_password:
    file: $DOCKERDIR/secrets/pia_password
  htpasswd:
    file: $DOCKERDIR/secrets/htpasswd
  http_password:
    file: $DOCKERDIR/secrets/http_password
  http_username:
    file: $DOCKERDIR/secrets/http_username
  nc_db_name:
    file: $DOCKERDIR/secrets/nc_db_name
  nc_db_user:
    file: $DOCKERDIR/secrets/nc_db_user
  nc_db_password:
    file: $DOCKERDIR/secrets/nc_db_password
  nc_admin_user:
    file: $DOCKERDIR/secrets/nc_admin_user
  nc_admin_password:
    file: $DOCKERDIR/secrets/nc_admin_password
  grafana_admin_user:
    file: $DOCKERDIR/secrets/grafana_admin_user
  grafana_pw:
    file: $DOCKERDIR/secrets/grafana_pw
  grafana_admin_pw:
    file: $DOCKERDIR/secrets/grafana_admin_pw
  cf_email:
    file: $DOCKERDIR/secrets/cf_email
  cf_api_key:
    file: $DOCKERDIR/secrets/cf_api_key
  traefik_forward_auth:
    file: $DOCKERDIR/secrets/traefik_forward_auth
  guac_db_name:
    file: $DOCKERDIR/secrets/guac_db_name
  guac_mysql_user:
    file: $DOCKERDIR/secrets/guac_mysql_user
  guac_mysql_password:
    file: $DOCKERDIR/secrets/guac_mysql_password
  peerport:
    file: $DOCKERDIR/pia/pia-shared/port.dat
  github_token:
    file: $DOCKERDIR/secrets/github_token
  trakt_clientid:
    file: $DOCKERDIR/secrets/trakt_clientid
  trakt_clientsecret:
    file: $DOCKERDIR/secrets/trakt_clientsecret
  trakt_pin:
    file: $DOCKERDIR/secrets/trakt_pin
  glances_password:
    file: $DOCKERDIR/secrets/glances_password
  glances_pass:
    file: $DOCKERDIR/secrets/glances_pass    
  portainer_key:
    file: $DOCKERDIR/secrets/portainer_key
  radarr_api:
    file: $DOCKERDIR/secrets/radarr_api_key
  sonarr_api:
    file: $DOCKERDIR/secrets/sonarr_api_key
  lidarr_api:
    file: $DOCKERDIR/secrets/lidarr_api_key
  bazarr_api:
    file: $DOCKERDIR/secrets/bazarr_api_key
  mylar_api:
    file: $DOCKERDIR/secrets/mylar_api_key
  readarr_api:
    file: $DOCKERDIR/secrets/readarr_api_key
  prowlarr_api:
    file: $DOCKERDIR/secrets/prowlarr_api_key
  tautulli_api:
    file: $DOCKERDIR/secrets/tautulli_api_key
  sabnzbd_api:
    file: $DOCKERDIR/secrets/sabnzbd_api_key
  ombi_api:
    file: $DOCKERDIR/secrets/ombi_api_key
  omdb_api:
    file: $DOCKERDIR/secrets/omdb_api_key
  tmdb_api:
    file: $DOCKERDIR/secrets/tmdb_api_key
  mdblist_api:
    file: $DOCKERDIR/secrets/mdblist_api_key
  hpusername:
    file: $DOCKERDIR/secrets/hpusername
  hppassword:
    file: $DOCKERDIR/secrets/hppassword


########################### SERVICES
services:

# Traefik 3 - Reverse Proxy
  traefik:
    <<: *common-keys-core
    image: traefik:3.2
    container_name: traefik
    profiles: ["infra", "all"]
    command: # CLI arguments
      - --global.checkNewVersion=true
      - --global.sendAnonymousUsage=false
      - --entryPoints.web.address=:80
      - --entryPoints.websecure.address=:443
      - --entryPoints.traefik.address=:8080
      # - --entryPoints.ping.address=:8081
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      - --api=true
      - --api.dashboard=true
      # - --api.insecure=true
      # - --ping=true
      # - --serversTransport.insecureSkipVerify=true
      - --entrypoints.https.forwardedHeaders.trustedIPs=$CLOUDFLARE_IPS,$IPWHITELIST
      - --log=true
      - --log.filePath=/logs/traefik.log
      - --log.level=INFO # (Default: error) DEBUG, INFO, WARN, ERROR, FATAL, PANIC
      - --accessLog=true
      - --accessLog.filePath=/logs/access.log
      - --accessLog.bufferingSize=100 # Configuring a buffer of 100 lines
      - --accessLog.filters.statusCodes=204-299,400-499,500-599
      - --providers.docker=true
      - --providers.docker.endpoint=unix:///var/run/docker.sock # Disable for Socket Proxy. Enable otherwise.
      #- --providers.docker.endpoint=tcp://socket-proxy:2375 # Enable for Socket Proxy. Disable otherwise.
      - --providers.docker.exposedByDefault=false
      - --providers.docker.network=t3_proxy 
      # - --providers.docker.swarmMode=false # Traefik v2 Swarm
      # - --providers.swarm.endpoint=tcp://127.0.0.1:2377 # Traefik v3 Swarm
      - --entrypoints.websecure.http.tls=true
      - --entrypoints.websecure.http.tls.options=tls-opts@file
      # Add dns-cloudflare as default certresolver for all services. Also enables TLS and no need to specify on individual services
      - --entrypoints.websecure.http.tls.certresolver=dns-cloudflare
      - --entrypoints.websecure.http.tls.domains[0].main=$DOMAINNAME
      - --entrypoints.websecure.http.tls.domains[0].sans=*.$DOMAINNAME
      #- --entrypoints.websecure.http.tls.domains[1].main=$DOMAINNAME_1
      #- --entrypoints.websecure.http.tls.domains[1].sans=*.$DOMAINNAME_1
      - --providers.file.directory=/rules # Load dynamic configuration from one or more .toml or .yml files in a directory
      - --providers.file.watch=true # Only works on top level files in the rules folder
      # - --certificatesResolvers.dns-cloudflare.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory # LetsEncrypt Staging Server - uncomment when testing
      - --certificatesResolvers.dns-cloudflare.acme.storage=/acme.json
      - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.provider=cloudflare
      - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.resolvers=1.1.1.1:53,1.0.0.1:53
      - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.delayBeforeCheck=90 # To delay DNS check and reduce LE hitrate
#      - --experimental.plugins.cloudflarewarp.modulename=github.com/BetterCorp/cloudflarewarp
#      - --experimental.plugins.cloudflarewarp.version=v1.3.3
    networks:
      t3_proxy:
        ipv4_address: $TRAEFIK_IP
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
    volumes:
      - $DOCKERDIR/traefik3/rules:/rules
      - /var/run/docker.sock:/var/run/docker.sock:ro # Use Docker Socket Proxy instead for improved security
      - $DOCKERDIR/traefik3/acme/acme.json:/acme.json # cert location - you must touch this file and change permissions to 600
      - $DOCKERDIR/traefik3/logs:/logs # for fail2ban - make sure to touch file before starting container
    environment:
      <<: *default-tz-puid-pgid
      DOMAINNAME: $DOMAINNAME
      CF_API_EMAIL_FILE: /run/secrets/cf_email
      CF_API_KEY_FILE: /run/secrets/cf_api_key
      HTPASSWD_FILE: /run/secrets/htpasswd
    secrets:
      - cf_email
      - cf_api_key
      - htpasswd
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.traefik-rtr.entrypoints=websecure"
      - "traefik.http.routers.traefik-rtr.rule=Host(`traefik.$DOMAINNAME`)"
      ## Services - API
      - "traefik.http.routers.traefik-rtr.service=api@internal"
      ## Middlewares
      - "traefik.http.routers.traefik-rtr.middlewares=chain-oauth@file"

# Google OAuth - Single Sign On using OAuth 2.0
  # https://hub.docker.com/r/thomseddon/traefik-forward-auth
  # https://www.smarthomebeginner.com/google-oauth-with-traefik-docker/
  oauth:
    <<: *common-keys-core
    image: reddthebamf/traefik-forward-auth:1.23.2-alpine-amd64 #thomseddon/traefik-forward-auth
    container_name: oauth
    profiles: ["infra", "all"]
    volumes:
      - $DOCKERDIR/oauth/rules:/rules
    environment:
      - CONFIG=/config
      - COOKIE_DOMAIN=$DOMAINNAME
      - INSECURE_COOKIE=false
      - AUTH_HOST=oauth.$DOMAINNAME
      - URL_PATH=/_oauth
      - LOG_LEVEL=warn # set to trace while testing bypass rules
      - LOG_FORMAT=text
      - LIFETIME=86400 # 1 day
      - DEFAULT_ACTION=auth
      - DEFAULT_PROVIDER=google
    secrets:
      - source: traefik_forward_auth
        target: /config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.oauth-rtr.entrypoints=websecure"
      - "traefik.http.routers.oauth-rtr.rule=Host(`oauth.$DOMAINNAME`)"
      - "traefik.http.routers.oauth-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.oauth-rtr.service=oauth-svc"
      - "traefik.http.services.oauth-svc.loadbalancer.server.port=4181"

# Portainer - WebUI for Containers
  portainer:
    <<: *common-keys-core
    image: portainer/portainer-ce
    container_name: portainer
    profiles: ["infra", "all"]
    command: -H unix:///var/run/docker.sock
#    ports:
#      - "$PORTAINER_PORT:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - $DOCKERDIR/portainer/data:/data
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer-rtr.entrypoints=websecure"
      - "traefik.http.routers.portainer-rtr.rule=Host(`portainer.$DOMAINNAME`)"
      - "traefik.http.routers.portainer-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.portainer-rtr.service=portainer-svc"
      - "traefik.http.services.portainer-svc.loadbalancer.server.port=9000"

# Homepage - Application Dashboard
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
    networks:
      - t3_proxy
    # ports:
    #  - "$HOMEPAGE_PORT:3000" 
    volumes:
      - $DOCKERDIR/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro # pass local proxy
      - $USERDIR/media:/media
    environment:
      TZ: $TZ
      PUID: $PUID
      PGID: 999
      HOMEPAGE_VAR_DOMAINNAME: $DOMAINNAME
      HOMEPAGE_VAR_HDHOMERUN_IP: $HDHOMERUN_IP
      HOMEPAGE_VAR_SERVER_IP: $SERVER_IP
      HOMEPAGE_VAR_ROUTER_IP: $ROUTER_IP
      HOMEPAGE_VAR_PLEX_PORT: $PLEX_PORT
      HOMEPAGE_VAR_HOMEPAGE_LABEL: $HOMEPAGE_LABEL
      HOMEPAGE_VAR_HOMEPAGE_LAT: $HOMEPAGE_LAT
      HOMEPAGE_VAR_HOMEPAGE_LONG: $HOMEPAGE_LONG
      HOMEPAGE_VAR_HOMEPAGE_TZ: $TZ
      HOMEPAGE_FILE_HPUSERNAME: /run/secrets/hpusername
      HOMEPAGE_FILE_HPPASSWORD: /run/secrets/hppassword
      HOMEPAGE_FILE_GLANCES_PASS: /run/secrets/glances_pass
      HOMEPAGE_FILE_PLEX_TOKEN: /run/secrets/plex_token
      HOMEPAGE_FILE_PORTAINER_KEY: /run/secrets/portainer_key
      HOMEPAGE_FILE_TRANSMISSION_RPC_PASSWORD: /run/secrets/transmission_rpc_password
      HOMEPAGE_FILE_TRANSMISSION_RPC_USERNAME: /run/secrets/transmission_rpc_username
      HOMEPAGE_FILE_RADARR_API: /run/secrets/radarr_api
      HOMEPAGE_FILE_SONARR_API: /run/secrets/sonarr_api
      HOMEPAGE_FILE_LIDARR_API: /run/secrets/lidarr_api
      HOMEPAGE_FILE_PROWLARR_API: /run/secrets/prowlarr_api
      HOMEPAGE_FILE_TAUTULLI_API: /run/secrets/tautulli_api
      HOMEPAGE_FILE_SABNZBD_API: /run/secrets/sabnzbd_api
      HOMEPAGE_FILE_BAZARR_API: /run/secrets/bazarr_api
      HOMEPAGE_FILE_READARR_API: /run/secrets/readarr_api
      HOMEPAGE_FILE_MYLAR_API: /run/secrets/mylar_api
    secrets:
      - hpusername
      - hppassword
      - portainer_key
      - glances_pass
      - plex_token
      - transmission_rpc_password
      - transmission_rpc_username
      - sabnzbd_api
      - radarr_api
      - sonarr_api
      - lidarr_api
      - prowlarr_api
      - tautulli_api
      - bazarr_api
      - ombi_api
      - readarr_api
      - mylar_api
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.homepage-rtr.entrypoints=websecure"
      - "traefik.http.routers.homepage-rtr.rule=Host(`www.$DOMAINNAME`)"
      # Middlewares
      - "traefik.http.routers.homepage-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.homepage-rtr.service=homepage-svc"
      - "traefik.http.services.homepage-svc.loadbalancer.server.port=3000"

# MariaDB - MySQL Database
  mariadb:
    image: linuxserver/mariadb
    container_name: mariadb
    hostname: mariadb
    networks:
      - default
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
#    ports:
#      - "$MARIADB_PORT:3306"
    volumes:
      - $DOCKERDIR/mariadb/data:/config
    environment:
      <<: *default-tz-puid-pgid
      FILE__MYSQL_ROOT_PASSWORD: /run/secrets/mysql_root_password
    secrets:
      - mysql_root_password

# phpMyAdmin - Database management
  phpmyadmin:
    <<: *common-keys-apps
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    profiles: ["infra", "all"]
    networks:
       - default
       - t3_proxy
#    ports:
#      - "$PHPMYADMIN_PORT:80"
    environment:
      <<: *default-tz-puid-pgid
      PMA_HOST: $MARIADB_HOST
      PMA_PORT: $MARIADB_PORT
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
    secrets:
      - mysql_root_password
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.phpmyadmin-rtr.entrypoints=websecure"
      - "traefik.http.routers.phpmyadmin-rtr.rule=Host(`pma.$DOMAINNAME`)"
      - "traefik.http.routers.phpmyadmin-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.phpmyadmin-rtr.service=phpmyadmin-svc"
      - "traefik.http.services.phpmyadmin-svc.loadbalancer.server.port=80"

# Guacamole - Remote desktop, SSH, on Telnet on any HTML5 Browser 
# Create all databases and tables first
  guacamole:
    image: guacamole/guacamole
    container_name: guacamole
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "remote"]
    networks:
      - t3_proxy
      - default
    volumes:
      - $DOCKERDIR/guacamole/temp:/temp
#    ports:
#      - "$GUACAMOLE_PORT:8080"
    environment:
      <<: *default-tz-puid-pgid
      REMOTE_IP_VALUE_ENABLED: true
      GUACD_HOSTNAME: guacd
      MYSQL_HOSTNAME: $MARIADB_HOST
      MYSQL_PORT: $MARIADB_PORT
      MYSQL_DATABASE_FILE: /run/secrets/guac_db_name
      MYSQL_USER_FILE: /run/secrets/guac_mysql_user
      MYSQL_PASSWORD_FILE: /run/secrets/guac_mysql_password
    secrets:
      - guac_db_name
      - guac_mysql_user
      - guac_mysql_password
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.guacamole-rtr.entrypoints=websecure"
      - "traefik.http.routers.guacamole-rtr.rule=Host(`guac.$DOMAINNAME`)"
      - "traefik.http.routers.guacamole-rtr.middlewares=chain-oauth@file,add-guacamole"
      - "traefik.http.middlewares.add-guacamole.addPrefix.prefix=/guacamole"
      - "traefik.http.routers.guacamole-rtr.service=guacamole-svc"
      - "traefik.http.services.guacamole-svc.loadbalancer.server.port=8080"

# Guacamole Daemon - Needed for Guacamole
  guacd:
#    <<: *common-keys-core
    image: guacamole/guacd
    container_name: guacd
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "remote"]

# Cloudflare DDNS - Dynamic DNS Updater
  cloudddns:
    <<: *common-keys-core
    image: reddthebamf/cloudflare-ddns:22-alpine3.19 #joshava/cloudflare-ddns
    container_name: cloudddns
    profiles: ["infra", "all"]
    volumes:
      - $DOCKERDIR/cloudflare-ddns/config.yaml:/app/config.yaml
    environment:
      <<: *default-tz-puid-pgid
      DOMAINNAME: $DOMAINNAME

# Mosquitto - MQTT Broker
# Create mosquitto.conf, passwd, mosquitto.log files  and set permissions to 775 user:docker
# dexec mosquitto /bin/sh -> mosquitto_passwd -b /mosquitto/config/passwd username passwd
  mosquitto:
    image: eclipse-mosquitto
    container_name: mosquitto
    networks:
      - default
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
#    ports:
#      - "$MOSQUITTO_HTTP_PORT:1883" #http
#      - "9001:9001" #websockets
#      - "$MOSQUITTO_HTTPS_PORT:8883" #https 
    volumes:
      - $DOCKERDIR/mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - $DOCKERDIR/mosquitto/data:/mosquitto/data
      - $DOCKERDIR/mosquitto/config/passwd:/mosquitto/config/passwd
      - $DOCKERDIR/shared:/shared
    environment:
      <<: *default-tz-puid-pgid

############################# DATABASE

# Postgres - Database for TeslaMate
  postgres:
    image: postgres:15
    container_name: postgres
    networks:
      - default
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
    volumes:
      - $DOCKERDIR/postgres:/var/lib/postgresql/data
    environment:
      <<: *default-tz-puid-pgid
      POSTGRES_DB__FILE: /run/secrets/teslamate_db_name
      POSTGRES_USER__FILE: /run/secrets/teslamate_db_user
      POSTGRES_PASSWORD__FILE: /run/secrets/teslamate_db_password
    secrets:
      - teslamate_db_name
      - teslamate_db_user
      - teslamate_db_password
#      POSTGRES_MULTIPLE_DATABASES: statping-{{ statping_db_pass }},teslamate-{{ teslamate_db_pass }}

# Gluetun - VPN Client for Docker Containers and More
# Gluetun only for use by torrent clients + on demand lan devices.
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["vpn"]
    networks:
      - t3_proxy
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    dns:
      - 1.1.1.1
      - 1.0.0.1
    ports:
      - "8081:8080" # Exposing qBittorrent through Docker Host LAN IP
    # #   - 8888:8888/tcp # HTTP proxy
    # #   - 8388:8388/tcp # Shadowsocks
    # #   - 8388:8388/udp # Shadowsocks
    volumes:
      - $DOCKERDIR/gluetun:/gluetun
      - $DOCKERDIR/gluetun/portforward:/tmp/gluetun/
    environment:
      TZ: $TZ
      # Wireguard
      # VPN_SERVICE_PROVIDER: surfshark
      # VPN_TYPE: wireguard
      # WIREGUARD_PRIVATE_KEY: $SURFSHARK_WG_PRIVATE_KEY
      # WIREGUARD_ADDRESSES: 10.14.0.2/16
      # SERVER_COUNTRIES: Netherlands
      # OpenVPN
      VPN_SERVICE_PROVIDER: private internet access
      VPN_TYPE: openvpn
      VPN_PORT_FORWARDING: on
      #PRIVATE_INTERNET_ACCESS_VPN_PRIVATE_INTERNET_ACCESS_VPN_PORT_FORWARDING_STATUS_FILE: /gluetun/forwarded_port
      VPN_PORT_FORWARDING_STATUS_FILE: /tmp/gluetun/forwarded_port
      VPN_PORT_FORWARDING_USERNAME_SECRETFILE: /run/secrets/openvpn_user
      VPN_PORT_FORWARDING_PASSWORD_SECRETFILE: /run/secrets/openvpn_password
      OPENVPN_CONFIG: Argentina
#      DNS_SERVER: 1.0.0.1, 1.1.1.1
      OPENVPN_OPTS: --inactive 3600 --ping 10 --ping-exit 60
    secrets:
      - source: pia_username
        target: /run/secrets/openvpn_user
      - source: pia_password
        target: /run/secrets/openvpn_password
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.gluetun-qbittorrent-rtr.entrypoints=websecure"
      - "traefik.http.routers.gluetun-qbittorrent-rtr.rule=Host(`qbit.$DOMAINNAME`)" # qBittorrent
      # Middlewares
      - "traefik.http.routers.gluetun-qbittorrent-rtr.middlewares=chain-oauth@file" # qBittorrent
      # HTTP Services
      - "traefik.http.routers.gluetun-qbittorrent-rtr.service=gluetun-svc" # qBittorrent
      - "traefik.http.services.gluetun-svc.loadbalancer.server.port=8080" # qBittorrent

  # qBittorrent - Torrent downloader
  # Needs trailing / if using PathPrefixStrip
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["media", "downloads"]
    network_mode: "service:gluetun"
    # ports:
    #   - "8081:8080" # Explosed via gluetun. 8081 because crowdsec is using port 8080
    volumes:
      - $DOCKERDIR/qbittorrent:/config
      - $DOCKERDIR/gluetun/portforward:/tmp/gluetun/
      - $DOWNLOAD_DIR:/downloads # Ensure that downloads folder is set to /data/downloads in qBittorrent
    environment:
      TZ: $TZ
      PUID: $PUID
      PGID: $PGID
      UMASK_SET: 002
      TORRENTING_PORT_FILE: /tmp/gluetun/forwarded_port
    healthcheck: # https://github.com/qdm12/gluetun/issues/641#issuecomment-933856220
      test: "curl -sf https://example.com  || exit 1"
      interval: 1m
      timeout: 10s
      retries: 1
    labels: # Traefik labels added via glueten
      - "deunhealth.restart.on.unhealthy=true"

############################# DOWNLOADERS
# TransmissionBT - Torrent Downloader
  transmission:
    <<: *common-keys-apps
#    image: linuxserver/transmission:latest
    image: haugene/transmission-openvpn
    container_name: transmission
    profiles: ["media", "downloads", "all"]
    networks:
      t3_proxy:
        ipv4_address: $TRANSMISSION_IP
    # ports:
    #   - "$TRANSMISSION_PORT:9091"
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    dns:
      - 1.1.1.1
      - 1.0.0.1
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $DOCKERDIR/transmission/data:/data
      - $DOCKERDIR/transmission/config:/config
      - $DOWNLOAD_DIR:/downloads
    environment:
      <<: *default-tz-puid-pgid
#      OPENVPN_PROVIDER: GIGANEWS
#      OPENVPN_USERNAME: $GN_USERNAME
#      OPENVPN_PASSWORD: $GN_PASSWORD
#      OPENVPN_CONFIG: "USA-Austin-256"
      OPENVPN_PROVIDER: PIA
      OPENVPN_USERNAME__FILE: /run/secrets/pia_username
      OPENVPN_PASSWORD__FILE: /run/secrets/pia_password
      OPENVPN_CONFIG: "argentina"
      OPENVPN_OPTS: --inactive 3600 --ping 10 --ping-exit 60
      LOCAL_NETWORK: $LOCAL_NETWORK
      UMASK_SET: 002
      TRANSMISSION_RPC_AUTHENTICATION_REQUIRED: "false"
      TRANSMISSION_RPC_HOST_WHITELIST: transmission,transmission.$DOMAINNAME
      TRANSMISSION_RPC_WHITELIST: $IPWHITELIST
      TRANSMISSION_UMASK: 002
      TRANSMISSION_RATIO_LIMIT: 0
      TRANSMISSION_RATIO_LIMIT_ENABLED: "true"
      TRANSMISSION_IDLE_SEEDING_LIMIT: 5
      TRANSMISSION_IDLE_SEEDING_LIMIT_ENABLED: "true"
#      TRANSMISSION_ALT_SPEED_DOWN: 2000
#      TRANSMISSION_ALT_SPEED_ENABLED: "true"
#      TRANSMISSION_ALT_SPEED_UP: 15
#      TRANSMISSION_SPEED_LIMIT_DOWN: 6000
#      TRANSMISSION_SPEED_LIMIT_DOWN_ENABLED: "true"
      TRANSMISSION_SPEED_LIMIT_UP: 200
      TRANSMISSION_SPEED_LIMIT_UP_ENABLED: "true"
      # TRANSMISSION_BLOCKLIST_URL: "http://john.bitsurge.net/public/biglist.p2p.gz"
      TRANSMISSION_PEER_LIMIT_GLOBAL: 1000
      TRANSMISSION_PEER_LIMIT_PER_TORRENT: 100
      TRANSMISSION_DOWNLOAD_QUEUE_SIZE: 10
      TRANSMISSION_DOWNLOAD_QUEUE_ENABLED: "true"
      TRANSMISSION_QUEUE_STALLED_MINUTES: 30
      TRANSMISSION_QUEUE_STALLED_ENABLED: "true"
      TRANSMISSION_INCOMPLETE_DIR: "/downloads/incomplete/transmission"
      TRANSMISSION_INCOMPLETE_DIR_ENABLED: "true"
      TRANSMISSION_WATCH_DIR: "/downloads"
      TRANSMISSION_WATCH_DIR_ENABLED: "true"
      TRANSMISSION_DOWNLOAD_DIR: "/downloads/completed/transmission"
      TRANSMISSION_RPC_USERNAME_FILE: "/run/secrets/transmission_rpc_username"
      TRANSMISSION_RPC_PASSWORD_FILE: "/run/secrets/transmission_rpc_password"
    secrets:
      - pia_username
      - pia_password
      - transmission_rpc_username
      - transmission_rpc_password
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.transmission-rtr.entrypoints=websecure"
      - "traefik.http.routers.transmission-rtr.rule=Host(`transmission.$DOMAINNAME`)"
      - "traefik.http.routers.transmission-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.transmission-rtr.service=transmission-svc"
      - "traefik.http.services.transmission-svc.loadbalancer.server.port=9091"

# SABnzbd - Binary newsgrabber (NZB downloader)
  sabnzbd:
    <<: *common-keys-apps 
    image: linuxserver/sabnzbd
    container_name: sabnzbd
    profiles: ["media", "downloads", "all"]
#    ports:
#      - "$SABNZBD_PORT:8080"
    volumes:
      - $DOCKERDIR/sabnzbd:/config
      - $DOWNLOAD_DIR:/downloads
      - $DOWNLOAD_DIR/incomplete:/incomplete
      - $USERDIR/media/storage:/storage
    environment:
      <<: *default-tz-puid-pgid
      UMASK_SET: 002
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.sabnzbd-rtr-bypass.entrypoints=websecure"
      - "traefik.http.routers.sabnzbd-rtr-bypass.rule=Host(`sabnzbd.$DOMAINNAME`) && (Header(`X-Api-Key`, `$SABNZBD_API`) || Query(`apikey`, `$SABNZBD_API`))"
      - "traefik.http.routers.sabnzbd-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.sabnzbd-rtr.entrypoints=websecure"
      - "traefik.http.routers.sabnzbd-rtr.rule=Host(`sabnzbd.$DOMAINNAME`)"
      - "traefik.http.routers.sabnzbd-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.sabnzbd-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.sabnzbd-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.sabnzbd-rtr.service=sabnzbd-svc"
      - "traefik.http.routers.sabnzbd-rtr-bypass.service=sabnzbd-svc"
      - "traefik.http.services.sabnzbd-svc.loadbalancer.server.port=8080"

############################# INDEXERS
# PROWLARR - NZB/TOR Proxy Search
  prowlarr:
    <<: *common-keys-apps
    image: linuxserver/prowlarr:develop
    container_name: prowlarr
    profiles: ["media", "all"]
    environment:
      <<: *default-tz-puid-pgid
    volumes:
      - $DOCKERDIR/prowlarr/data:/config
#    ports:
#      - $PROWLARR_PORT:9696
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.prowlarr-rtr-bypass.entrypoints=websecure"
      - "traefik.http.routers.prowlarr-rtr-bypass.rule=Host(`prowlarr.$DOMAINNAME`) && (Header(`X-Api-Key`, `$PROWLARR_API`) || Query(`apikey`, `$PROWLARR_API`))"
      - "traefik.http.routers.prowlarr-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.prowlarr-rtr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr-rtr.rule=Host(`prowlarr.$DOMAINNAME`)"
      - "traefik.http.routers.prowlarr-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.prowlarr-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.prowlarr-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.prowlarr-rtr.service=prowlarr-svc"
      - "traefik.http.routers.prowlarr-rtr-bypass.service=prowlarr-svc"
      - "traefik.http.services.prowlarr-svc.loadbalancer.server.port=9696"

  flaresolverr:
    <<: *common-keys-apps
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    profiles: ["media", "all"]
    environment:
      <<: *default-tz-puid-pgid
      #LOG_LEVEL: ${LOG_LEVEL:-info}
      #LOG_HTML: ${LOG_HTML:-false}
      CAPTCHA_SOLVER: ${CAPTCHA_SOLVER:-none}
#    ports:
#      - "${PORT:-8191}:8191"

# # NZBHydra2 - NZB meta search
#   hydra:
#     <<: *common-keys-apps
#     image: linuxserver/nzbhydra2
#     container_name: hydra
#     profiles: ["media", "all"]
# #    ports:
# #      - "$NZBHYDRA_PORT:5076"
#     volumes:
#       - $DOCKERDIR/hydra2:/config
#       - $DOWNLOAD_DIR:/downloads
#     environment:
#       <<: *default-tz-puid-pgid
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.hydra-rtr.entrypoints=websecure"
#       - "traefik.http.routers.hydra-rtr.rule=Host(`hydra.$DOMAINNAME`)"
#       - "traefik.http.routers.hydra-rtr.middlewares=chain-oauth@file"
#       - "traefik.http.routers.hydra-rtr.service=hydra-svc"
#       - "traefik.http.services.hydra-svc.loadbalancer.server.port=5076"

############################# PVRS

# Lidarr - Music Management
  lidarr:
    <<: *common-keys-apps
    image: linuxserver/lidarr
    container_name: lidarr
    profiles: ["media", "all"]
#    ports:
#      - "$LIDARR_PORT:8686"
    volumes:
      - $DOCKERDIR/lidarr:/config
      - $DOWNLOAD_DIR:/downloads
      - $USERDIR/media/music:/music
      - "/etc/localtime:/etc/localtime:ro"
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.lidarr-rtr-bypass.entrypoints=websecure"
      - "traefik.http.routers.lidarr-rtr-bypass.rule=Host(`lidarr.$DOMAINNAME`) && (Header(`X-Api-Key`, `$LIDARR_API`) || Query(`apikey`, `$LIDARR_API`))"
      - "traefik.http.routers.lidarr-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.lidarr-rtr.entrypoints=websecure"
      - "traefik.http.routers.lidarr-rtr.rule=Host(`lidarr.$DOMAINNAME`)"
      - "traefik.http.routers.lidarr-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.lidarr-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.lidarr-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.lidarr-rtr.service=lidarr-svc"
      - "traefik.http.routers.lidarr-rtr-bypass.service=lidarr-svc"
      - "traefik.http.services.lidarr-svc.loadbalancer.server.port=8686"

# Radarr - Movie management
  radarr:
    <<: *common-keys-apps
    image: linuxserver/radarr:nightly
    container_name: radarr
    profiles: ["media", "all"]
#    ports:
#      - "$RADARR_PORT:7878"
    volumes:
      - $DOCKERDIR/radarr:/config
      - $DOWNLOAD_DIR:/downloads
      - $USERDIR/media/movies:/movies
      - $USERDIR/media/kidsmovies:/kidsmovies
      - "/etc/localtime:/etc/localtime:ro"
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.radarr-rtr-bypass.entrypoints=websecure"
      - "traefik.http.routers.radarr-rtr-bypass.rule=Host(`radarr.$DOMAINNAME`) && (Header(`X-Api-Key`, `$RADARR_API`) || Query(`apikey`, `$RADARR_API`))"
      - "traefik.http.routers.radarr-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.radarr-rtr.entrypoints=websecure"
      - "traefik.http.routers.radarr-rtr.rule=Host(`radarr.$DOMAINNAME`)"
      - "traefik.http.routers.radarr-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.radarr-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.radarr-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.radarr-rtr.service=radarr-svc"
      - "traefik.http.routers.radarr-rtr-bypass.service=radarr-svc"
      - "traefik.http.services.radarr-svc.loadbalancer.server.port=7878"

# Sonarr - TV Shows management
  sonarr:
    <<: *common-keys-apps
    image: linuxserver/sonarr:develop
    container_name: sonarr
    profiles: ["media", "all"]
#    ports:
#      - "$SONARR_PORT:8989"
    volumes:
      - $DOCKERDIR/sonarr:/config
      - $DOWNLOAD_DIR:/downloads
      - $USERDIR/media/tvshows:/tv
      - "/etc/localtime:/etc/localtime:ro"
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.sonarr-rtr-bypass.entrypoints=websecure"
      - "traefik.http.routers.sonarr-rtr-bypass.rule=Host(`sonarr.$DOMAINNAME`) && (Header(`X-Api-Key`, `$SONARR_API`) || Query(`apikey`, `$SONARR_API`))"
      - "traefik.http.routers.sonarr-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.sonarr-rtr.entrypoints=websecure"
      - "traefik.http.routers.sonarr-rtr.rule=Host(`sonarr.$DOMAINNAME`)"
      - "traefik.http.routers.sonarr-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.sonarr-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.sonarr-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.sonarr-rtr.service=sonarr-svc"
      - "traefik.http.routers.sonarr-rtr-bypass.service=sonarr-svc"
      - "traefik.http.services.sonarr-svc.loadbalancer.server.port=8989"

# Book Manager and Automation
  readarr:
    <<: *common-keys-apps
    image: linuxserver/readarr:nightly
    container_name: readarr
    profiles: ["media", "all"]
#    ports:
#      - "$READARR_PORT:8989"
    volumes:
      - $DOCKERDIR/readarr/config:/config:Z
      - $DOWNLOAD_DIR:/downloads
      - $USERDIR/media/books:/books
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.readarr-rtr-bypass.entrypoints=websecure"
      - "traefik.http.routers.readarr-rtr-bypass.rule=Host(`readarr.$DOMAINNAME`) && (Header(`X-Api-Key`, `$READARR_API`) || Query(`apikey`, `$READARR_API`))"
      - "traefik.http.routers.readarr-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.readarr-rtr.entrypoints=websecure"
      - "traefik.http.routers.readarr-rtr.rule=Host(`readarr.$DOMAINNAME`)"
      - "traefik.http.routers.readarr-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.readarr-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.readarr-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.readarr-rtr.service=readarr-svc"
      - "traefik.http.routers.readarr-rtr-bypass.service=readarr-svc"
      - "traefik.http.services.readarr-svc.loadbalancer.server.port=8787"

# Mylar - Comic Book management
  mylar:
    <<: *common-keys-apps
    image: linuxserver/mylar3
    container_name: mylar
    profiles: ["media", "all"]
#    ports:
#      - "$MYLAR_PORT:8090"
    volumes:
      - $DOCKERDIR/mylar:/config
      - $DOWNLOAD_DIR:/downloads
      - $USERDIR/media/comics:/comics
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.mylar-rtr-bypass.entrypoints=websecure"
      - "traefik.http.routers.mylar-rtr-bypass.rule=Host(`mylar.$DOMAINNAME`) && (Header(`X-Api-Key`, `$MYLAR_API`) || Query(`apikey`, `$MYLAR_API`))"
      - "traefik.http.routers.mylar-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.mylar-rtr.entrypoints=websecure"
      - "traefik.http.routers.mylar-rtr.rule=Host(`mylar.$DOMAINNAME`)"
      - "traefik.http.routers.mylar-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.mylar-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.mylar-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.mylar-rtr.service=mylar-svc"
      - "traefik.http.routers.mylar-rtr-bypass.service=mylar-svc"
      - "traefik.http.services.mylar-svc.loadbalancer.server.port=8090"

# Youtube Downloader
  metube:
    <<: *common-keys-apps 
    image: ghcr.io/alexta69/metube
    container_name: metube
    profiles: ["media", "all"]
#    ports:
#      - "8081:8081"
    volumes:
      - $DOWNLOAD_DIR:/downloads
    environment:
      <<: *default-tz-puid-pgid
      DEFAULT_THEME: dark
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.metube-rtr.entrypoints=websecure"
      - "traefik.http.routers.metube-rtr.rule=Host(`metube.$DOMAINNAME`)"
      - "traefik.http.routers.metube-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.metube-rtr.service=metube-svc"
      - "traefik.http.services.metube-svc.loadbalancer.server.port=8081"

#Notifiarr
  notifiarr:
    <<: *common-keys-apps
    image: golift/notifiarr
    container_name: notifiarr
    hostname: notifiarr
    profiles: ["media", "all"]
#    privileged: true
#    ports:
#      - "5454:5454"
    volumes:
      - $DOCKERDIR/notifiarr:/config
      - /var/run/utmp:/var/run/utmp
      - /etc/machine-id:/etc/machine-id
    environment:
      <<: *default-tz-puid-pgid
##      DN_UI_PASSWORD: $HTTP_PASSWORD
      DN_API_KEY: $NOTIFIARR_API
      DN_LIDARR_0_NAME: Lidarr.$DOMAINNAME
      DN_LIDARR_0_URL: http://lidarr:8686/lidarr
      DN_LIDARR_0_API_KEY: $LIDARR_API
      DN_PROWLARR_0_NAME: Prowlarr.$DOMAINNAME
      DN_PROWLARR_0_URL: http://prowlarr:9696
      DN_PROWLARR_0_API_KEY: $PROWLARR_API
#      DN_PROWLARR_0_USERNAME_FILE: /run/secrets/http_username #$HTTP_USERNAME
#      DN_PROWLARR_0_PASSWORD_FILE: /run/secrets/http_password #$HTTP_PASSWORD
      DN_RADARR_0_NAME: Radarr.$DOMAINNAME
      DN_RADARR_0_URL: http://radarr:7878/radarr
      DN_RADARR_0_API_KEY: $RADARR_API
      DN_READARR_0_NAME: Readarr.$DOMAINNAME
      DN_READARR_0_URL: http://readarr:8787/readarr
      DN_READARR_0_API_KEY: $READARR_API
      DN_SONARR_0_NAME: Sonarr.$DOMAINNAME
      DN_SONARR_0_URL: http://sonarr:8989/sonarr
      DN_SONARR_0_API_KEY: $SONARR_API
      DN_SABNZBD_0_NAME: Sabnzbd.$DOMAINNAME
      DN_SABNZBD_0_URL: http://sabnzbd:8080
      DN_SABNZBD_0_API_KEY: $SABNZBD_API
      #DN_TRANSMISSION_0_NAME: Transmission.$DOMAINNAME
      #DN_TRANSMISSION_0_URL: http://transmission:9091
      #DN_TRANSMISSION_0_USERNAME: 
      #DN_TRANSMISSION_0_PASSWORD: 
      DN_LIDARR_1_NAME: Lidarr2.$DOMAINNAME
      DN_LIDARR_1_URL: https://lidarr2.$DOMAINNAME/lidarr
      DN_LIDARR_1_API_KEY: $LIDARR_API
      DN_PROWLARR_1_NAME: Prowlarr2.$DOMAINNAME
      DN_PROWLARR_1_URL: https://prowlarr2.$DOMAINNAME
      DN_PROWLARR_1_API_KEY: $PROWLARR_API
#      DN_PROWLAR_1_USERNAME_FILE: /run/secrets/http_username #$HTTP_USERNAME
#      DN_PROWLAR_1_PASSWORD_FILE: /run/secrets/http_password #$HTTP_PASSWORD
      DN_RADARR_1_NAME: Radarr2.$DOMAINNAME
      DN_RADARR_1_URL: https://radarr2.$DOMAINNAME/radarr
      DN_RADARR_1_API_KEY: $RADARR_API
      DN_SONARR_1_NAME: Sonarr2.$DOMAINNAME
      DN_SONARR_1_URL: https://sonarr2.$DOMAINNAME/sonarr
      DN_SONARR_1_API_KEY: $SONARR_API
      DN_SABNZBD_1_NAME: Sabnzbd2.$DOMAINNAME
      DN_SABNZBD_1_URL: https://sabnzbd2.$DOMAINNAME
      DN_SABNZBD_1_API_KEY: $SABNZBD_API
      DN_LIDARR_2_NAME: Lidarr.$DOMAINNAME2
      DN_LIDARR_2_URL: https://lidarr.$DOMAINNAME2/lidarr
      DN_LIDARR_2_API_KEY: $LIDARR_API
      DN_PROWLARR_2_NAME: Prowlarr.$DOMAINNAME2
      DN_PROWLARR_2_URL: https://prowlarr.$DOMAINNAME2
      DN_PROWLARR_2_API_KEY: $PROWLARR_API
#      DN_PROWLAR_2_USERNAME_FILE: /run/secrets/http_username #$HTTP_USERNAME
#      DN_PROWLAR_2_PASSWORD_FILE: /run/secrets/http_password #$HTTP_PASSWORD
      DN_RADARR_2_NAME: Radarr.$DOMAINNAME2
      DN_RADARR_2_URL: https://radarr.$DOMAINNAME2/radarr
      DN_RADARR_2_API_KEY: $RADARR_API
      DN_SONARR_2_NAME: Sonarr.$DOMAINNAME2
      DN_SONARR_2_URL: https://sonarr.$DOMAINNAME2/sonarr
      DN_SONARR_2_API_KEY: $SONARR_API
      DN_SABNZBD_2_NAME: Sabnzbd.$DOMAINNAME2
      DN_SABNZBD_2_URL: https://sabnzbd.$DOMAINNAME2
      DN_SABNZBD_2_API_KEY: $SABNZBD_API
      DN_RADARR_3_NAME: Radarr.$DOMAINNAME3
      DN_RADARR_3_URL: https://radarr.$DOMAINNAME3/radarr
      DN_RADARR_3_API_KEY: $RADARR2_API
      DN_SONARR_3_NAME: Sonarr.$DOMAINNAME3
      DN_SONARR_3_URL: https://sonarr.$DOMAINNAME3/sonarr
      DN_SONARR_3_API_KEY: $SONARR2_API
      DN_LIDARR_3_NAME: Lidarr.$DOMAINNAME3
      DN_LIDARR_3_URL: https://lidarr.$DOMAINNAME3/lidarr
      DN_LIDARR_3_API_KEY: $LIDARR2_API
      DN_SABNZBD_3_NAME: Sabnzbd.$DOMAINNAME3
      DN_SABNZBD_3_URL: https://sabnzbd.$DOMAINNAME3
      DN_SABNZBD_3_API_KEY: $SABNZBD2_API
      DN_PROWLARR_3_NAME: Prowlarr.$DOMAINNAME3
      DN_PROWLARR_3_URL: https://prowlarr.$DOMAINNAME3
      DN_PROWLARR_3_API_KEY: $PROWLARR2_API
      DN_READARR_1_NAME: Readarr.$DOMAINNAME3
      DN_READARR_1_URL: https://readarr.$DOMAINNAME3/readarr
      DN_READARR_1_API_KEY: $READARR2_API
      DN_PLEX_URL: https://plex.$DOMAINNAME
#      DN_PLEX_TOKEN_FILE: /run/secrets/plex_token #$PLEX_TOKEN
      DN_TAUTULLI_NAME: Tautulli.$DOMAINNAME
      DN_TAUTULLI_URL: http://tautulli:8181
      DN_TAUTULLI_API_KEY: $TAUTULLI_API
    secrets:
      - http_username
      - http_password
      - plex_token
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.notifiarr-rtr-bypass.entrypoints=websecure"
      - "traefik.http.routers.notifiarr-rtr-bypass.rule=Host(`notifiarr.$DOMAINNAME`) && (Header(`X-Api-Key`, `$NOTIFIARR_API`) || Query(`apikey`, `$NOTIFIARR_API`))"
      - "traefik.http.routers.notifiarr-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.notifiarr-rtr.entrypoints=websecure"
      - "traefik.http.routers.notifiarr-rtr.rule=Host(`notifiarr.$DOMAINNAME`)"
      - "traefik.http.routers.notifiarr-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.notifiarr-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.notifiarr-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.notifiarr-rtr.service=notifiarr-svc"
      - "traefik.http.routers.notifiarr-rtr-bypass.service=notifiarr-svc"
      - "traefik.http.services.notifiarr-svc.loadbalancer.server.port=5454"

############################# MEDIA
  plex:
    <<: *common-keys-apps
    image: linuxserver/plex
    container_name: plex
    profiles: ["media", "all"]
    # runtime: nvidia
    environment:
      <<: *default-tz-puid-pgid
      FILE__PLEX_CLAIM: /run/secrets/plex_claim
      ADVERTISE_IP: http://$SERVER_IP:$PLEX_PORT/,https://plex.$DOMAINNAME/
      ALLOWED_NETWORKS: $IPWHITELIST
      VERSION: docker
      # NVIDIA_VISIBLE_DEVICES: all
      # NVIDIA_DRIVER_CAPABILITIES: compute,video,utility
    devices:
      - /dev/dri:/dev/dri
    secrets:
      - plex_claim
    hostname: plex
    networks:
      t3_proxy:
    ports:
      - $PLEX_PORT:32400/tcp
      - 3005:3005/tcp
      - 8324:8324/tcp
      - 32469:32469/tcp
      - 1900:1900/udp
      - 32410:32410/udp
      - 32412:32412/udp
      - 32413:32413/udp
      - 32414:32414/udp
    volumes:
      - $DOCKERDIR/Plex/preroll:/preroll
      - $USERDIR/media:/media
      - $DOCKERDIR/Plex/DB:/config
      - /dev/shm:/transcode
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.plex-rtr.entrypoints=websecure"
      - "traefik.http.routers.plex-rtr.rule=Host(`plex.$DOMAINNAME`)"
      - "traefik.http.routers.plex-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.plex-rtr.service=plex-svc"
      - "traefik.http.services.plex-svc.loadbalancer.server.port=32400"

#Plex Meta Manager - Automatic Metadata Manager for Plex
  plexmm:
    <<: *common-keys-apps
    image: linuxserver/kometa
    container_name: plexmm
    profiles: ["media", "all"]
    depends_on:
      - plex
    environment:
      <<: *default-tz-puid-pgid
      KOMETA_CONFIG: /config/config.yml #optional
      KOMETA_TIMES: 05:00 #optional
#      KOMETA_RUN: "True" #optional
      KOMETA_TEST: "False" #optional
      KOMETA_NO_MISSING: "False" #optional
      KOMETA_PLEXTOKEN: $PLEX_TOKEN
      KOMETA_TRAKTCLIENTID: $TRAKT_CLIENTID
      KOMETA_TRAKTCLIENTSECRET: $TRAKT_CLIENTSECRET
      KOMETA_TRAKTPIN: $TRAKT_PIN
      KOMETA_GITHUBTOKEN: $GITHUB_TOKEN
      KOMETA_RADARRAPI: $RADARR_API
      KOMETA_SONARRAPI: $SONARR_API
      KOMETA_MDBLISTAPI: $MDBLIST_API
      KOMETA_OMDBAPI: $OMDB_API
      KOMETA_TMDBAPI: $TMDB_API
      KOMETA_TAUTULLIAPI: $TAUTULLI_API
      KOMETA_SERVERIP: $SERVER_IP
      KOMETA_PLEXPORT: $PLEX_PORT
      KOMETA_NOTIFIARRAPI: $NOTIFIARR_API
    volumes:
      - $DOCKERDIR/plex-meta-manager/config:/config:rw
    secrets:
      - plex_token
      - trakt_clientid
      - trakt_clientsecret
      - trakt_pin
      - github_token
      - sonarr_api
      - radarr_api
      - mdblist_api
      - omdb_api
      - tmdb_api
      - tautulli_api

#Plex Image Cleanup
  plexic:
    <<: *common-keys-apps
    image: meisnate12/plex-image-cleanup
    container_name: plexic
    profiles: ["media", "all"]
    depends_on:
      - plex
    environment:
      <<: *default-tz-puid-pgid
      PLEX_PATH: /plex
      MODE: remove
      SCHEDULE: "07:00|weekly(sunday)"
      PLEX_URL: http://$SERVER_IP:$PLEX_PORT
      PLEX_TOKEN: /run/secrets/plex_token
      #DISCORD=https://discord.com/api/webhooks/###################/####################################################################
      TIMEOUT: 600
      SLEEP: 60
      IGNORE_RUNNING: True
      LOCAL_DB: False
      USE_EXISTING: False
      PHOTO_TRANSCODER: False
      EMPTY_TRASH: True
      CLEAN_BUNDLES: True
      OPTIMIZE_DB: True
      TRACE: False
      LOG_REQUESTS: True
    secrets:
      - plex_token
    volumes:
      - $DOCKERDIR/plex-image-cleanup/config:/config
      - $DOCKERDIR/Plex/DB/Library/Application Support/Plex Media Server:/plex

# LMS - Music Server
  lms:
    <<: *common-keys-apps
    image: lmscommunity/logitechmediaserver
    container_name: lms
    profiles: ["media", "all"]
    ports:
      - "$LMS_PORT1:9000"
      - "$LMS_PORT2:9090"
      - "$LMS_PORT3:3483"
      - "$LMS_PORT3:3483/udp"
    volumes:
      - $USERDIR/media/music:/srv/music:ro
      - $DOCKERDIR/squeezebox:/srv/squeezebox
      - /etc/localtime:/etc/localtime:ro
    environment:
      <<: *default-tz-puid-pgid
      JAVA_OPTS: -Dserver.use-forward-headers=true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lms-rtr.entrypoints=websecure"
      - "traefik.http.routers.lms-rtr.rule=Host(`lms.$DOMAINNAME`)"
      - "traefik.http.routers.lms-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.lms-rtr.service=lms-svc"
      - "traefik.http.services.lms-svc.loadbalancer.server.port=9000"

# Ombi - Media Requests
  ombi:
    image: linuxserver/ombi
    container_name: ombi
    networks:
      - default
      - t3_proxy
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["media", "all"]
#    ports:
#      - "$OMBI_PORT:3579"
    volumes:
      - $DOCKERDIR/ombi:/config
    environment:
      <<: *default-tz-puid-pgid
      BASE_URL: /ombi #optional
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ombi-rtr.entrypoints=websecure"
      - "traefik.http.routers.ombi-rtr.priority=99"
      - "traefik.http.routers.ombi-rtr.rule=Host(`ombi.$DOMAINNAME`)"
      - "traefik.http.routers.ombi-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.ombi-rtr.service=ombi-svc"
      - "traefik.http.services.ombi-svc.loadbalancer.server.port=3579"
      ## API Oauth Bypass
      - "traefik.http.routers.ombi-api-rtr.entrypoints=websecure"
      - "traefik.http.routers.ombi-api-rtr.rule=Host(`ombi.$DOMAINNAME`) && PathPrefix(`/api/`)"
      - "traefik.http.routers.ombi-api-rtr.priority=100"
      - "traefik.http.routers.ombi-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.ombi-api-rtr.service=ombi-svc"

# Tautulli - Plex statistics and monitoring
  tautulli:
    <<: *common-keys-apps
    image: linuxserver/tautulli
    container_name: tautulli
    profiles: ["media", "all"]
#    ports:
#      - "$TAUTULLI_PORT:8181"
    volumes:
      - $DOCKERDIR/tautulli/config:/config
      - $DOCKERDIR/tautulli/logs:/logs:ro
    environment:
      <<: *default-tz-puid-pgid
    depends_on:
      - plex
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tautulli-rtr.entrypoints=websecure"
      - "traefik.http.routers.tautulli-rtr.priority=99"
      - "traefik.http.routers.tautulli-rtr.rule=Host(`tautulli.$DOMAINNAME`)"
      - "traefik.http.routers.tautulli-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.tautulli-rtr.service=tautulli-svc"
      - "traefik.http.services.tautulli-svc.loadbalancer.server.port=8181"
      ## API Oauth Bypass
      - "traefik.http.routers.tautulli-api-rtr.entrypoints=websecure"
      - "traefik.http.routers.tautulli-api-rtr.rule=Host(`tautulli.${DOMAINNAME}`) && (Header(`X-Api-Key`, `${TAUTULLI_DEVICE_KEY}`) || Query(`apikey`, `${TAUTULLI_DEVICE_KEY}`))"
      - "traefik.http.routers.tautulli-api2-rtr.rule=Host(`tautulli.${DOMAINNAME}`) && (Header(`X-Api-Key`, `${TAUTULLI_API}`) || Query(`apikey`, `${TAUTULLI_API}`))"
      - "traefik.http.routers.tautulli-api-rtr.priority=100"
      - "traefik.http.routers.tautulli-api2-rtr.priority=101"
      - "traefik.http.routers.tautulli-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.tautulli-api-rtr.service=tautulli-svc"

############################# MEDIA FILE MANAGEMENT

# Bazarr - Subtitle Management
  bazarr:
    <<: *common-keys-apps
    image: linuxserver/bazarr
    container_name: bazarr
    profiles: ["media", "all"]
#    ports:
#      - "$BAZARR_PORT:6767"
    volumes:
      - $DOCKERDIR/bazarr:/config
      - $USERDIR/media/movies:/movies
      - $USERDIR/media/tvshows:/tv
      - $USERDIR/media/kidsmovies:/kidsmovies
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.bazarr-rtr-bypass.entrypoints=websecure"
      - "traefik.http.routers.bazarr-rtr-bypass.rule=Host(`bazarr.$DOMAINNAME`) && (Header(`X-Api-Key`, `$BAZARR_API`) || Query(`apikey`, `$BAZARR_API`))"
      - "traefik.http.routers.bazarr-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.bazarr-rtr.entrypoints=websecure"
      - "traefik.http.routers.bazarr-rtr.rule=Host(`bazarr.$DOMAINNAME`)"
      - "traefik.http.routers.bazarr-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.bazarr-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.bazarr-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.bazarr-rtr.service=bazarr-svc"
      - "traefik.http.routers.bazarr-rtr-bypass.service=bazarr-svc"
      - "traefik.http.services.bazarr-svc.loadbalancer.server.port=6767"

# Handbrake - Video Conversion (Transcoding and compression)
  handbrake:
    <<: *common-keys-apps
    image: jlesage/handbrake
    container_name: handbrake
    profiles: ["avedit", "all"]
#    ports:
#      - "$HANDBRAKE_PORT:5800"
    volumes:
      - $DOWNLOAD_DIR:/downloads:ro
      - $USERDIR/media:/media:rw
      - $DOCKERDIR/handbrake/config:/config:rw
      - $DOCKERDIR/handbrake/watch:/watch:rw
      - $DOWNLOAD_DIR/wip_media:/output:rw
      - $USERDIR/media/storage:/base_storage:rw
    environment:
      <<: *default-tz-puid-pgid
      UMASK: 002
      KEEP_APP_RUNNING: 1
      CLEAN_TMP_DIR: 1
      DISPLAY_WIDTH: 1600
      DISPLAY_HEIGHT: 960
      AUTOMATED_CONVERSION_KEEP_SOURCE: 1
    devices:
      - /dev/dri:/dev/dri
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.handbrake-rtr.entrypoints=websecure"
      - "traefik.http.routers.handbrake-rtr.rule=Host(`handbrake.$DOMAINNAME`)"
      - "traefik.http.routers.handbrake-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.handbrake-rtr.service=handbrake-svc"
      - "traefik.http.services.handbrake-svc.loadbalancer.server.port=5800"

# MKVToolNix - Video Editing (Remuxing - changing media container while keeping original source quality)
  mkvtoolnix:
    <<: *common-keys-apps
    image: jlesage/mkvtoolnix
    container_name: mkvtoolnix
    profiles: ["avedit", "all"]
#    ports:
#      - "$MKVTOOLNIX_PORT:5800"
    volumes:
      - $USERDIR/media:/media:rw
      - $DOWNLOAD_DIR:/downloads:rw
      - $DOCKERDIR/mkvtoolnix/config:/config:rw
      - $USERDIR/media/storage:/base_storage:rw
    environment:
      <<: *default-tz-puid-pgid
      UMASK: 002
      KEEP_APP_RUNNING: 1
      CLEAN_TMP_DIR: 1
      DISPLAY_WIDTH: 1600
      DISPLAY_HEIGHT: 960
      DARK_MODE: 1
    devices:
      - /dev/dri:/dev/dri
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mkvtoolnix-rtr.entrypoints=websecure"
      - "traefik.http.routers.mkvtoolnix-rtr.rule=Host(`mkvtoolnix.$DOMAINNAME`)"
      - "traefik.http.routers.mkvtoolnix-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.mkvtoolnix-rtr.service=mkvtoolnix-svc"
      - "traefik.http.services.mkvtoolnix-svc.loadbalancer.server.port=5800"

# # MKVcleaver is a GUI (Graphical User Interface) for mkvtoolnix, designed to extract data from MKV files.
#   mkvcleaver:
#     <<: *common-keys-apps
#     image: jlesage/mkvcleaver
#     container_name: mkvcleaver
#     profiles: ["avedit"]
# #    ports:
# #      - "$MKVCLEAVER_PORT:5800"
#     volumes:
#       - $USERDIR/media:/media:rw
#       - $DOWNLOAD_DIR:/downloads:rw
#       - $DOCKERDIR/mkvcleaver/config:/config:rw
#       - $USERDIR/media/storage:/base_storage:rw
#     environment:
#       <<: *default-tz-puid-pgid
#       UMASK: 002
#       KEEP_APP_RUNNING: 1
#       CLEAN_TMP_DIR: 1
#       DISPLAY_WIDTH: 1600
#       DISPLAY_HEIGHT: 960
#       DARK_MODE: 1
#     devices:
#       - /dev/dri:/dev/dri
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.mkvcleaver-rtr.entrypoints=websecure"
#       - "traefik.http.routers.mkvcleaver-rtr.rule=Host(`mkvcleaver.$DOMAINNAME`)"
#       - "traefik.http.routers.mkvcleaver-rtr.middlewares=chain-oauth@file"
#       - "traefik.http.routers.mkvcleaver-rtr.service=mkvcleaver-svc"
#       - "traefik.http.services.mkvcleaver-svc.loadbalancer.server.port=5800"

# # MakeMKV - Video Editing (Ripping from Disks)
#   makemkv:
#     <<: *common-keys-apps
#     image: jlesage/makemkv
#     container_name: makemkv
#     profiles: ["avedit", "all"]
# #    ports:
# #      - "$MAKEMKV_PORT:5800"
#     volumes:
#       - $USERDIR/media:/media:rw
#       - $DOWNLOAD_DIR:/downloads:rw
#       - $DOCKERDIR/makemkv/config:/config:rw
#       - $USERDIR/media/storage:/storage:rw
#       - /mnt/cdrom:/mnt/cdrom
#     environment:
#       <<: *default-tz-puid-pgid
#       UMASK: 002
#       KEEP_APP_RUNNING: 1
#       CLEAN_TMP_DIR: 1
#       DISPLAY_WIDTH: 1600
#       DISPLAY_HEIGHT: 960
#     devices:
#       - /dev/dri:/dev/dri
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.makemkv-rtr.entrypoints=websecure"
#       - "traefik.http.routers.makemkv-rtr.rule=Host(`makemkv.$DOMAINNAME`)"
#       - "traefik.http.routers.makemkv-rtr.middlewares=chain-oauth@file"
#       - "traefik.http.routers.makemkv-rtr.service=makemkv-svc"
#       - "traefik.http.services.makemkv-svc.loadbalancer.server.port=5800"

############################# UTILITIES

# Glances - System Information
  glances:
    <<: *common-keys-apps
    image: nicolargo/glances
    container_name: glances
    profiles: ["infra", "all"]
    privileged: true
#    ports:
#      - "$GLANCES_PORT:61208"
    pid: host
    volumes:
      - $DOCKERDIR/glances/glances.conf:/glances/conf/glances.conf # Use this if you want to add a glances.conf file
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      <<: *default-tz-puid-pgid
#      GLANCES_OPT: "-C /glances/conf/glances.conf --quiet --export influxdb"
      GLANCES_OPT: "-w --password"
    secrets:
      - source: glances_password
        target: /root/.config/glances/glances.pwd
    labels:
      - "traefik.enable=true"
      # HTTP Routers Auth Bypass
      - "traefik.http.routers.glances-rtr-bypass.entrypoints=websecure"
      - "traefik.http.routers.glances-rtr-bypass.rule=Host(`glances.$DOMAINNAME`) && PathPrefix(`/api`)"
      - "traefik.http.routers.glances-rtr-bypass.priority=100"
      # HTTP Routers Auth
      - "traefik.http.routers.glances-rtr.entrypoints=websecure"
      - "traefik.http.routers.glances-rtr.rule=Host(`glances.$DOMAINNAME`)"
      - "traefik.http.routers.glances-rtr.priority=99"
      # Middlewares
      - "traefik.http.routers.glances-rtr-bypass.middlewares=chain-no-auth@file"
      - "traefik.http.routers.glances-rtr.middlewares=chain-no-auth@file"
      # HTTP Services
      - "traefik.http.routers.glances-rtr.service=glances-svc"
      - "traefik.http.routers.glances-rtr-bypass.service=glances-svc"
      - "traefik.http.services.glances-svc.loadbalancer.server.port=61208"

# Dozzle - Real-time Docker Log Viewer
  dozzle:
    <<: *common-keys-apps
    image: amir20/dozzle
    container_name: dozzle
    profiles: ["infra", "all"]
#    ports:
#      - "$DOZZLE_PORT:8080"
    environment:
      <<: *default-tz-puid-pgid
      DOZZLE_LEVEL: info
#      DOZZLE_TAILSIZE: 300
      DOZZLE_FILTER: "status=running"
      DOZZLE_NO_ANALYTICS: 1
#      DOZZLE_FILTER: "label=log_me" # limits logs displayed to containers with this label
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dozzle-rtr.entrypoints=websecure"
      - "traefik.http.routers.dozzle-rtr.rule=Host(`dozzle.$DOMAINNAME`)"
      - "traefik.http.routers.dozzle-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.dozzle-rtr.service=dozzle-svc"
      - "traefik.http.services.dozzle-svc.loadbalancer.server.port=8080"

# WatchTower - Automatic Docker Container Updates
  watchtower:
    <<: *common-keys-apps
    image: containrrr/watchtower
    container_name: watchtower
    profiles: ["infra", "all"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Use Docker Socket Proxy and comment this line for improved security.
    environment:
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_REMOVE_VOLUMES: "true"
      WATCHTOWER_INCLUDE_STOPPED: "true"
      WATCHTOWER_NO_STARTUP_MESSAGE: "false"
      WATCHTOWER_SCHEDULE: "0 30 12 * * *" # Everyday at 12:30
      # DOCKER_HOST: tcp://socket-proxy:2375 # Use this if you have Socket Proxy enabled.
      DOCKER_API_VERSION: "1.43"

# Docker-GC - Automatic Docker Garbage Collection 
# Create docker-gc-exclude file
  dockergc:
    <<: *common-keys-apps
    image: clockworksoul/docker-gc-cron
    container_name: docker-gc
    profiles: ["infra", "all"]
#    network_mode: none
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - $DOCKERDIR/docker-gc/docker-gc-exclude:/etc/docker-gc-exclude
    environment:
      <<: *default-tz-puid-pgid
      CRON: 0 0 0 * * ?
      FORCE_IMAGE_REMOVAL: 1
      FORCE_CONTAINER_REMOVAL: 0
      GRACE_PERIOD_SECONDS: 604800
      DRY_RUN: 0
      CLEAN_UP_VOLUMES: 1

# Traefik Certs Dumper - Extract LetsEncrypt Certificates - Traefik2 Compatible
  certdumper:
    <<: *common-keys-apps
    image: humenius/traefik-certs-dumper #kereis/traefik-certs-dumper:multi-arch-builds-alpine
    container_name: traefik_certdumper
    profiles: ["infra", "all"]
#    command: --restart-containers container1,container2,container3
    volumes:
      - $DOCKERDIR/traefik3/acme:/traefik:ro
      - $DOCKERDIR/shared/certs:/output:rw
#    - /var/run/docker.sock:/var/run/docker.sock:ro # only needed if restarting containers
    environment:
      <<: *default-tz-puid-pgid
      DOMAIN: $DOMAINNAME

#NextCloud - Cloud based File Storage
  nextcloud:
    image: linuxserver/nextcloud:latest
    container_name: nextcloud
    networks:
      - default
      - t3_proxy
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
    volumes:
      - $DOCKERDIR/nextcloud/config:/config
      - $DOCKERDIR/nextcloud/data:/data
      - $USERDIR/media/pictures:/data/media/pictures
      - $USERDIR/media/storage/Documents:/data/media/documents
    environment:
      <<: *default-tz-puid-pgid
      REDIS_HOST: nc-redis
      NEXTCLOUD_DOMAIN_NAME: nextcloud.$DOMAINNAME
      NEXTCLOUD_TRUSTED_DOMAIN: nextcloud.$DOMAINNAME
      TRUSTED_PROXIES: $TRAEFIK_NETWORK
      FILE__MYSQL_DATABASE: /run/secrets/nc_db_name
      FILE__MYSQL_USER: /run/secrets/nc_db_user
      FILE__MYSQL_PASSWORD: /run/secrets/nc_db_password
      MYSQL_HOST: $MARIADB_HOST
      MYSQL_PORT: $MARIADB_PORT
      NEXTCLOUD_DATA_DIR: /var/www/html/data
      FILE__NEXTCLOUD_ADMIN_USER: /run/secrets/nc_admin_user
      FILE__NEXTCLOUD_ADMIN_PASSWORD: /run/secrets/nc_admin_password
    secrets:
      - nc_admin_password
      - nc_admin_user
      - nc_db_name
      - nc_db_user
      - nc_db_password
    depends_on:
      - nc-redis
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.$DOMAINNAME`)"
      - "traefik.http.routers.nextcloud.middlewares=chain-nextcloud@file"
      - "traefik.http.routers.nextcloud.service=nextcloud"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"

  nc-redis:
    image: redis:alpine
    container_name: nc-redis
    hostname: nc-redis
    profiles: ["infra", "all"]
    networks:
      - default
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    environment:
      <<: *default-tz-puid-pgid
#      ENABLE_OVERCOMMIT_MEMORY: "true"

# Firefox - Web Broswer
  firefox:
    <<: *common-keys-apps
    image: jlesage/firefox:latest
    container_name: firefox
    security_opt:
      - seccomp:unconfined # October 15, 2020 https://github.com/jlesage/docker-firefox/blob/master/README.md#allowing-the-membarrier-system-call
    profiles: ["ff"]
    # ports:
    #   - "$FIREFOX_PORT:5800"
    volumes:
      - $DOCKERDIR/firefox:/config
      - $DOWNLOAD_DIR:/data/downloads
      - /dev/shm:/dev/shm
    environment:
      <<: *default-tz-puid-pgid
      UMASK: 002
      KEEP_APP_RUNNING: 1
      CLEAN_TMP_DIR: 1
      DISPLAY_WIDTH: 1920
      DISPLAY_HEIGHT: 1080
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.firefox-rtr.entrypoints=websecure"
      - "traefik.http.routers.firefox-rtr.rule=Host(`firefox.$DOMAINNAME`)"
      - "traefik.http.routers.firefox-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.firefox-rtr.service=firefox-svc"
      - "traefik.http.services.firefox-svc.loadbalancer.server.port=5800"

# VSCode - VSCode Editing
  vscode:
    <<: *common-keys-apps
    image: lscr.io/linuxserver/code-server:latest
    container_name: vscode
    profiles: ["infra", "all"]
#    ports:
#      - "8443:8443"
    volumes:
      - $DOCKERDIR:/data/docker
      - $USERDIR:/data/server
#      - $DATADIR:/data/data
      - $DOCKERDIR/vscode:/config
    environment:
      <<: *default-tz-puid-pgid
      # DOCKER_HOST: tcp://socket-proxy:2375
      # PASSWORD: $VSCODE_PASSWORD
      # HASHED_PASSWORD: #optional
      # SUDO_PASSWORD: password #optional
      # SUDO_PASSWORD_HASH: #optional
      # PROXY_DOMAIN: code-server.my.domain #optional
#      DEFAULT_WORKSPACE: /config/data/User/Workspaces/AZ.code-workspace #optional
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vscode-rtr.entrypoints=websecure"
      - "traefik.http.routers.vscode-rtr.rule=Host(`code.$DOMAINNAME`)"
      - "traefik.http.routers.vscode-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.vscode-rtr.service=vscode-svc"
      - "traefik.http.services.vscode-svc.loadbalancer.server.port=8443"

  whoami:
    image: traefik/whoami
    container_name: whoami
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
    networks:
      - t3_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami-rtr.entrypoints=websecure"
      - "traefik.http.routers.whoami-rtr.rule=Host(`whoami.$DOMAINNAME`)"
      - "traefik.http.routers.whoami-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.whoami-rtr.service=whoami-svc"
      - "traefik.http.services.whoami-svc.loadbalancer.server.port=80"

volumes:
  teslamate-grafana-data:
