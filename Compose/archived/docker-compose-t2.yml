#version: "3.9"
########################### NETWORKS
networks:
  t2_proxy:
    name: t2_proxy
    driver: bridge
    ipam:
      config:
        - subnet: $TRAEFIK_NETWORK
  default:
    driver: bridge

# Common environment values
x-environment: &default-tz-puid-pgid
  TZ: $TZ
  PUID: $PUID
  PGID: $PGID

# Keys common to some of the services in basic-services.txt
x-common-keys-core: &common-keys-core
  networks:
    - t2_proxy
  security_opt:
    - no-new-privileges:true
  restart: always

# Keys common to some of the dependent services/apps
x-common-keys-apps: &common-keys-apps
  networks:
    - t2_proxy
  security_opt:
    - no-new-privileges:true
  restart: unless-stopped

# SECRETS
secrets:
  plex_claim:
    file: $DOCKERDIR/secrets/plex_claim
  plex_token:
    file: $DOCKERDIR/secrets/plex_token
  mysql_root_password:
    file: $DOCKERDIR/secrets/mysql_root_password
  teslamate_db_name:
    file: $DOCKERDIR/secrets/teslamate_db_name
  teslamate_db_user:
    file: $DOCKERDIR/secrets/teslamate_db_user
  teslamate_db_password:
    file: $DOCKERDIR/secrets/teslamate_db_password
  teslamate_ek:
    file: $DOCKERDIR/secrets/teslamate_ek
  transmission_rpc_username:
    file: $DOCKERDIR/secrets/transmission_rpc_username
  transmission_rpc_password:
    file: $DOCKERDIR/secrets/transmission_rpc_password
  pia_username:
    file: $DOCKERDIR/secrets/pia_username
  pia_password:
    file: $DOCKERDIR/secrets/pia_password
  htpasswd:
    file: $DOCKERDIR/secrets/htpasswd
  http_password:
    file: $DOCKERDIR/secrets/http_password
  http_username:
    file: $DOCKERDIR/secrets/http_username
  nc_db_name:
    file: $DOCKERDIR/secrets/nc_db_name
  nc_db_user:
    file: $DOCKERDIR/secrets/nc_db_user
  nc_db_password:
    file: $DOCKERDIR/secrets/nc_db_password
  nc_admin_user:
    file: $DOCKERDIR/secrets/nc_admin_user
  nc_admin_password:
    file: $DOCKERDIR/secrets/nc_admin_password
  grafana_admin_user:
    file: $DOCKERDIR/secrets/grafana_admin_user
  grafana_pw:
    file: $DOCKERDIR/secrets/grafana_pw
  grafana_admin_pw:
    file: $DOCKERDIR/secrets/grafana_admin_pw
  cf_email:
    file: $DOCKERDIR/secrets/cf_email
  cf_api_key:
    file: $DOCKERDIR/secrets/cf_api_key
  traefik_forward_auth:
    file: $DOCKERDIR/secrets/traefik_forward_auth
  guac_db_name:
    file: $DOCKERDIR/secrets/guac_db_name
  guac_mysql_user:
    file: $DOCKERDIR/secrets/guac_mysql_user
  guac_mysql_password:
    file: $DOCKERDIR/secrets/guac_mysql_password
  peerport:
    file: $DOCKERDIR/pia/pia-shared/port.dat
  github_token:
    file: $DOCKERDIR/secrets/github_token
  trakt_clientid:
    file: $DOCKERDIR/secrets/trakt_clientid
  trakt_clientsecret:
    file: $DOCKERDIR/secrets/trakt_clientsecret
  trakt_pin:
    file: $DOCKERDIR/secrets/trakt_pin
  glances_password:
    file: $DOCKERDIR/secrets/glances_password
  portainer_key:
    file: $DOCKERDIR/secrets/portainer_key
  radarr_api:
    file: $DOCKERDIR/secrets/radarr_api_key
  sonarr_api:
    file: $DOCKERDIR/secrets/sonarr_api_key
  lidarr_api:
    file: $DOCKERDIR/secrets/lidarr_api_key
  bazarr_api:
    file: $DOCKERDIR/secrets/bazarr_api_key
  mylar_api:
    file: $DOCKERDIR/secrets/mylar_api_key
  readarr_api:
    file: $DOCKERDIR/secrets/readarr_api_key
  prowlarr_api:
    file: $DOCKERDIR/secrets/prowlarr_api_key
  tautulli_api:
    file: $DOCKERDIR/secrets/tautulli_api_key
  sabnzbd_api:
    file: $DOCKERDIR/secrets/sabnzbd_api_key
  ombi_api:
    file: $DOCKERDIR/secrets/ombi_api_key
  omdb_api:
    file: $DOCKERDIR/secrets/omdb_api_key
  tmdb_api:
    file: $DOCKERDIR/secrets/tmdb_api_key
  mdblist_api:
    file: $DOCKERDIR/secrets/mdblist_api_key
  notifiarr_api:
    file: $DOCKERDIR/secrets/notifiarr_api_key


########################### SERVICES
services:

# Traefik 2 - Reverse Proxy
  traefik:
    <<: *common-keys-core
    image: traefik:2.11
    container_name: traefik
    profiles: ["infra", "all"]
    command: # CLI arguments
      - --global.checkNewVersion=true
      - --global.sendAnonymousUsage=false
      - --entryPoints.http.address=:80
      - --entryPoints.https.address=:443
      - --entrypoints.https.forwardedHeaders.trustedIPs=$CLOUDFLARE_IPS,$IPWHITELIST
      - --entrypoints.https.forwardedHeaders.insecure
      - --entryPoints.traefik.address=:8080
    # - --entryPoints.ping.address=:8082
      - --entrypoints.web.http.redirections.entrypoint.to=https
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      - --api=true
      # - --api.insecure=true
      - --api.dashboard=true
      #- --ping=true
      - --log=true
      - --log.level=ERROR # (Default: error) DEBUG, INFO, WARN, ERROR, FATAL, PANIC
      - --accessLog=true
      - --accessLog.filePath=/traefik.log
      - --accessLog.bufferingSize=100 # Configuring a buffer of 100 lines
      - --accessLog.filters.statusCodes=204-299,400-499,500-599
      - --providers.docker=true
      - --providers.docker.endpoint=unix:///var/run/docker.sock # Use Docker Socket Proxy instead for improved security
#      - --providers.docker.endpoint=tcp://socket-proxy:2375
      # Automatically set Host rule for services
      - --providers.docker.exposedByDefault=false
      - --entrypoints.https.http.tls.options=tls-opts@file
      # Add dns-cloudflare as default certresolver for all services. Also enables TLS and no need to specify on individual services
      - --entrypoints.https.http.tls.certresolver=dns-cloudflare
      - --entrypoints.https.http.tls.domains[0].main=$DOMAINNAME
      - --entrypoints.https.http.tls.domains[0].sans=*.$DOMAINNAME
      # - --entrypoints.https.http.tls.domains[1].main=$DOMAINNAME1 # Pulls main cert for second domain
      # - --entrypoints.https.http.tls.domains[1].sans=*.$DOMAINNAME1 # Pulls wildcard cert for second domain
      - --providers.docker.network=t2_proxy
      - --providers.docker.swarmMode=false
      - --providers.file.directory=/rules # Load dynamic configuration from one or more .toml or .yml files in a directory
      - --providers.file.watch=true # Only works on top level files in the rules folder
      # - --certificatesResolvers.dns-cloudflare.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory # LetsEncrypt Staging Server - uncomment when testing
      - --certificatesResolvers.dns-cloudflare.acme.email=$CLOUDFLARE_EMAIL
      - --certificatesResolvers.dns-cloudflare.acme.storage=/acme.json
      - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.provider=cloudflare
      - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.resolvers=1.1.1.1:53,1.0.0.1:53
      - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.delayBeforeCheck=90 # To delay DNS check and reduce LE hitrate
#      - --serversTransport.insecureSkipVerify=true
    networks:
      t2_proxy:
        ipv4_address: $TRAEFIK_IP
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
    volumes:
      - $DOCKERDIR/traefik/rules:/rules
      - /var/run/docker.sock:/var/run/docker.sock:ro # Use Docker Socket Proxy instead for improved security
      - $DOCKERDIR/traefik/acme/acme.json:/acme.json # cert location - you must touch this file and change permissions to 600
      - $DOCKERDIR/traefik/traefik.log:/traefik.log # for fail2ban - make sure to touch file before starting container
    environment:
      <<: *default-tz-puid-pgid
      DOMAINNAME: $DOMAINNAME
      CF_API_EMAIL_FILE: /run/secrets/cf_email
      CF_API_KEY_FILE: /run/secrets/cf_api_key
      HTPASSWD_FILE: /run/secrets/htpasswd # HTPASSWD_FILE can be whatever as it is not used/called anywhere.
    secrets:
      - cf_email
      - cf_api_key
      - htpasswd
    labels:
      - "traefik.enable=true"
      # HTTP-to-HTTPS Redirect
      # - "traefik.http.routers.http-catchall.entrypoints=http"
      # - "traefik.http.routers.http-catchall.rule=HostRegexp(`{host:.+}`)"
      # - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      # - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      # HTTP Routers
      - "traefik.http.routers.traefik-rtr.entrypoints=https"
      - "traefik.http.routers.traefik-rtr.rule=Host(`traefik.$DOMAINNAME`)"
      ## Services - API
      - "traefik.http.routers.traefik-rtr.service=api@internal"
      ## Middlewares
      - "traefik.http.routers.traefik-rtr.middlewares=chain-oauth@file"

# Google OAuth - Single Sign On using OAuth 2.0
  # https://hub.docker.com/r/thomseddon/traefik-forward-auth
  # https://www.smarthomebeginner.com/google-oauth-with-traefik-docker/
  oauth:
    <<: *common-keys-core
    image: reddthebamf/traefik-forward-auth:1.21rc-alpine-amd64 #thomseddon/traefik-forward-auth
    container_name: oauth
    profiles: ["infra", "all"]
    volumes:
      - $DOCKERDIR/oauth/rules:/rules
    environment:
      - CONFIG=/config
      - COOKIE_DOMAIN=$DOMAINNAME
      - INSECURE_COOKIE=false
      - AUTH_HOST=oauth.$DOMAINNAME
      - URL_PATH=/_oauth
      - LOG_LEVEL=warn # set to trace while testing bypass rules
      - LOG_FORMAT=text
      - LIFETIME=86400 # 1 day
      - DEFAULT_ACTION=auth
      - DEFAULT_PROVIDER=google
    secrets:
      - source: traefik_forward_auth
        target: /config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.oauth-rtr.entrypoints=https"
      - "traefik.http.routers.oauth-rtr.rule=Host(`oauth.$DOMAINNAME`)"
      - "traefik.http.routers.oauth-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.oauth-rtr.service=oauth-svc"
      - "traefik.http.services.oauth-svc.loadbalancer.server.port=4181"

# Portainer - WebUI for Containers
  portainer:
    <<: *common-keys-core
    image: portainer/portainer-ce
    container_name: portainer
    profiles: ["infra", "all"]
    command: -H unix:///var/run/docker.sock
#    ports:
#      - "$PORTAINER_PORT:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - $DOCKERDIR/portainer/data:/data
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer-rtr.entrypoints=https"
      - "traefik.http.routers.portainer-rtr.rule=Host(`portainer.$DOMAINNAME`)"
      - "traefik.http.routers.portainer-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.portainer-rtr.service=portainer-svc"
      - "traefik.http.services.portainer-svc.loadbalancer.server.port=9000"

# Homepage - Application Dashboard
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["apps", "all"]
    networks:
      - t2_proxy
    # ports:
    #  - "$HOMEPAGE_PORT:3000" 
    volumes:
      - $DOCKERDIR/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro # pass local proxy
    environment:
      TZ: $TZ
      PUID: $PUID
      PGID: $PGID
      HOMEPAGE_VAR_DOMAINNAME: $DOMAINNAME
      HOMEPAGE_VAR_HDHOMERUN_IP: $HDHOMERUN_IP
      HOMEPAGE_VAR_SERVER_IP: $SERVER_IP
      HOMEPAGE_VAR_PLEX_PORT: $PLEX_PORT
      HOMEPAGE_FILE_PLEX_TOKEN: /run/secrets/plex_token
      HOMEPAGE_FILE_GLANCES_PASSWORD: /run/secrets/glances_password
      HOMEPAGE_FILE_PORTAINER_KEY: /run/secrets/portainer_key
      HOMEPAGE_FILE_TRANSMISSION_RPC_PASSWORD: /run/secrets/transmission_rpc_password
      HOMEPAGE_FILE_TRANSMISSION_RPC_USERNAME: /run/secrets/transmission_rpc_username
      HOMEPAGE_FILE_RADARR_API: /run/secrets/radarr_api
      HOMEPAGE_FILE_SONARR_API: /run/secrets/sonarr_api
      HOMEPAGE_FILE_LIDARR_API: /run/secrets/lidarr_api
      HOMEPAGE_FILE_PROWLARR_API: /run/secrets/prowlarr_api
      HOMEPAGE_FILE_TAUTULLI_API: /run/secrets/tautulli_api
      HOMEPAGE_FILE_SABNZBD_API: /run/secrets/sabnzbd_api
      HOMEPAGE_FILE_BAZARR_API: /run/secrets/bazarr_api
      HOMEPAGE_FILE_OMBI_API: /run/secrets/ombi_api
      HOMEPAGE_FILE_READARR_API: /run/secrets/readarr_api
      HOMEPAGE_FILE_MYLAR_API: /run/secrets/mylar_api
    secrets:
      - portainer_key
      - glances_password
      - plex_token
      - transmission_rpc_password
      - transmission_rpc_username
      - sabnzbd_api
      - radarr_api
      - sonarr_api
      - lidarr_api
      - prowlarr_api
      - tautulli_api
      - bazarr_api
      - ombi_api
      - readarr_api
      - mylar_api
    labels:
      - "traefik.enable=true"
      # HTTP Routers
      - "traefik.http.routers.homepage-rtr.entrypoints=https"
      - "traefik.http.routers.homepage-rtr.rule=Host(`www.$DOMAINNAME`)"
      # Middlewares
      - "traefik.http.routers.homepage-rtr.middlewares=chain-oauth@file"
      # HTTP Services
      - "traefik.http.routers.homepage-rtr.service=homepage-svc"
      - "traefik.http.services.homepage-svc.loadbalancer.server.port=3000"

# MariaDB - MySQL Database
  mariadb:
    image: linuxserver/mariadb
    container_name: mariadb
    hostname: mariadb
    networks:
      - default
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
#    ports:
#      - "$MARIADB_PORT:3306"
    volumes:
      - $DOCKERDIR/mariadb/data:/config
    environment:
      <<: *default-tz-puid-pgid
      FILE__MYSQL_ROOT_PASSWORD: /run/secrets/mysql_root_password
    secrets:
      - mysql_root_password

# phpMyAdmin - Database management
  phpmyadmin:

    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    networks:
      - default
      - t2_proxy
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
#    ports:
#      - "$PHPMYADMIN_PORT:80"
    environment:
      <<: *default-tz-puid-pgid
      PMA_HOST: $MARIADB_HOST
      PMA_PORT: $MARIADB_PORT
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
    secrets:
      - mysql_root_password
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.phpmyadmin-rtr.entrypoints=https"
      - "traefik.http.routers.phpmyadmin-rtr.rule=Host(`pma.$DOMAINNAME`)"
      - "traefik.http.routers.phpmyadmin-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.phpmyadmin-rtr.service=phpmyadmin-svc"
      - "traefik.http.services.phpmyadmin-svc.loadbalancer.server.port=80"

# Guacamole - Remote desktop, SSH, on Telnet on any HTML5 Browser 
# Create all databases and tables first
  guacamole:
    image: guacamole/guacamole
    container_name: guacamole
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
    networks:
      - t2_proxy
      - default
    volumes:
      - $DOCKERDIR/guacamole/temp:/temp
#    ports:
#      - "$GUACAMOLE_PORT:8080"
    environment:
      <<: *default-tz-puid-pgid
      REMOTE_IP_VALUE_ENABLED: true
      GUACD_HOSTNAME: guacd
      MYSQL_HOSTNAME: $MARIADB_HOST
      MYSQL_PORT: $MARIADB_PORT
      MYSQL_DATABASE_FILE: /run/secrets/guac_db_name
      MYSQL_USER_FILE: /run/secrets/guac_mysql_user
      MYSQL_PASSWORD_FILE: /run/secrets/guac_mysql_password
    secrets:
      - guac_db_name
      - guac_mysql_user
      - guac_mysql_password
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.guacamole-rtr.entrypoints=https"
      - "traefik.http.routers.guacamole-rtr.rule=Host(`guac.$DOMAINNAME`)"
      - "traefik.http.routers.guacamole-rtr.middlewares=chain-oauth@file,add-guacamole"
      - "traefik.http.middlewares.add-guacamole.addPrefix.prefix=/guacamole"
      - "traefik.http.routers.guacamole-rtr.service=guacamole-svc"
      - "traefik.http.services.guacamole-svc.loadbalancer.server.port=8080"

# Guacamole Daemon - Needed for Guacamole
  guacd:
#    <<: *common-keys-core
    image: guacamole/guacd
    container_name: guacd
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]

# Cloudflare DDNS - Dynamic DNS Updater
  cloudddns:
    <<: *common-keys-core
    image: reddthebamf/cloudflare-ddns:20-alpine3.18 #joshava/cloudflare-ddns
    container_name: cloudddns
    profiles: ["infra", "all"]
    volumes:
      - $DOCKERDIR/cloudflare-ddns/config.yaml:/app/config.yaml
    environment:
      <<: *default-tz-puid-pgid
      DOMAINNAME: $DOMAINNAME

# Mosquitto - MQTT Broker
# Create mosquitto.conf, passwd, mosquitto.log files  and set permissions to 775 user:docker
# dexec mosquitto /bin/sh -> mosquitto_passwd -b /mosquitto/config/passwd username passwd
  mosquitto:
    <<: *common-keys-apps
    image: eclipse-mosquitto
    container_name: mosquitto
    profiles: ["infra", "all"]
#    ports:
#      - "$MOSQUITTO_HTTP_PORT:1883" #http
#      - "9001:9001" #websockets
#      - "$MOSQUITTO_HTTPS_PORT:8883" #https 
    volumes:
      - $DOCKERDIR/mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - $DOCKERDIR/mosquitto/data:/mosquitto/data
      - $DOCKERDIR/mosquitto/config/passwd:/mosquitto/config/passwd
      - $DOCKERDIR/shared:/shared
    environment:
      <<: *default-tz-puid-pgid

############################# DATABASE

# Postgres - Database for TeslaMate
  postgres:
    <<: *common-keys-core
    image: postgres:15
    container_name: postgres
    profiles: ["infra", "all"]
    volumes:
      - $DOCKERDIR/postgres:/var/lib/postgresql/data
    environment:
      <<: *default-tz-puid-pgid
      POSTGRES_DB__FILE: /run/secrets/teslamate_db_name
      POSTGRES_USER__FILE: /run/secrets/teslamate_db_user
      POSTGRES_PASSWORD__FILE: /run/secrets/teslamate_db_password
    secrets:
      - teslamate_db_name
      - teslamate_db_user
      - teslamate_db_password
#      POSTGRES_MULTIPLE_DATABASES: statping-{{ statping_db_pass }},teslamate-{{ teslamate_db_pass }}

############################# DOWNLOADERS
# TransmissionBT - Torrent Downloader
  transmission:
    <<: *common-keys-apps
#    image: linuxserver/transmission:latest
    image: haugene/transmission-openvpn
    container_name: transmission
    profiles: ["media", "all"]
    networks:
      t2_proxy:
        ipv4_address: $TRANSMISSION_IP
    # ports:
    #   - "$TRANSMISSION_PORT:9091"
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    dns:
      - 1.1.1.1
      - 1.0.0.1
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $DOCKERDIR/transmission/data:/data
      - $DOCKERDIR/transmission/config:/config
      - $DOWNLOAD_DIR:/downloads
    environment:
      <<: *default-tz-puid-pgid
#      OPENVPN_PROVIDER: GIGANEWS
#      OPENVPN_USERNAME: $GN_USERNAME
#      OPENVPN_PASSWORD: $GN_PASSWORD
#      OPENVPN_CONFIG: "USA-Austin-256"
      OPENVPN_PROVIDER: PIA
      OPENVPN_USERNAME__FILE: /run/secrets/pia_username
      OPENVPN_PASSWORD__FILE: /run/secrets/pia_password
      OPENVPN_CONFIG: "argentina"
      OPENVPN_OPTS: --inactive 3600 --ping 10 --ping-exit 60
      LOCAL_NETWORK: $LOCAL_NETWORK
      UMASK_SET: 002
      TRANSMISSION_RPC_AUTHENTICATION_REQUIRED: "false"
      TRANSMISSION_RPC_HOST_WHITELIST: transmission,transmission.$DOMAINNAME
      TRANSMISSION_RPC_WHITELIST: $IPWHITELIST
      TRANSMISSION_UMASK: 002
      TRANSMISSION_RATIO_LIMIT: 0
      TRANSMISSION_RATIO_LIMIT_ENABLED: "true"
      TRANSMISSION_IDLE_SEEDING_LIMIT: 5
      TRANSMISSION_IDLE_SEEDING_LIMIT_ENABLED: "true"
#      TRANSMISSION_ALT_SPEED_DOWN: 2000
#      TRANSMISSION_ALT_SPEED_ENABLED: "true"
#      TRANSMISSION_ALT_SPEED_UP: 15
#      TRANSMISSION_SPEED_LIMIT_DOWN: 6000
#      TRANSMISSION_SPEED_LIMIT_DOWN_ENABLED: "true"
      TRANSMISSION_SPEED_LIMIT_UP: 200
      TRANSMISSION_SPEED_LIMIT_UP_ENABLED: "true"
      # TRANSMISSION_BLOCKLIST_URL: "http://john.bitsurge.net/public/biglist.p2p.gz"
      TRANSMISSION_PEER_LIMIT_GLOBAL: 1000
      TRANSMISSION_PEER_LIMIT_PER_TORRENT: 100
      TRANSMISSION_DOWNLOAD_QUEUE_SIZE: 10
      TRANSMISSION_DOWNLOAD_QUEUE_ENABLED: "true"
      TRANSMISSION_QUEUE_STALLED_MINUTES: 30
      TRANSMISSION_QUEUE_STALLED_ENABLED: "true"
      TRANSMISSION_INCOMPLETE_DIR: "/downloads/incomplete/transmission"
      TRANSMISSION_INCOMPLETE_DIR_ENABLED: "true"
      TRANSMISSION_WATCH_DIR: "/downloads"
      TRANSMISSION_WATCH_DIR_ENABLED: "true"
      TRANSMISSION_DOWNLOAD_DIR: "/downloads/completed/transmission"
      TRANSMISSION_RPC_USERNAME_FILE: "/run/secrets/transmission_rpc_username"
      TRANSMISSION_RPC_PASSWORD_FILE: "/run/secrets/transmission_rpc_password"
    secrets:
      - pia_username
      - pia_password
      - transmission_rpc_username
      - transmission_rpc_password
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.transmission-rtr.entrypoints=https"
      - "traefik.http.routers.transmission-rtr.rule=Host(`transmission.$DOMAINNAME`)"
      - "traefik.http.routers.transmission-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.transmission-rtr.service=transmission-svc"
      - "traefik.http.services.transmission-svc.loadbalancer.server.port=9091"

# SABnzbd - Binary newsgrabber (NZB downloader)
  sabnzbd:
    <<: *common-keys-apps 
    image: linuxserver/sabnzbd
    container_name: sabnzbd
    profiles: ["media", "all"]
#    ports:
#      - "$SABNZBD_PORT:8080"
    volumes:
      - $DOCKERDIR/sabnzbd:/config
      - $DOWNLOAD_DIR:/downloads
      - $DOWNLOAD_DIR/incomplete:/incomplete
    environment:
      <<: *default-tz-puid-pgid
      UMASK_SET: 002
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sabnzbd-rtr.entrypoints=https"
      - "traefik.http.routers.sabnzbd-rtr.priority=99"
      - "traefik.http.routers.sabnzbd-rtr.rule=Host(`sabnzbd.$DOMAINNAME`)"
      - "traefik.http.routers.sabnzbd-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.sabnzbd-rtr.service=sabnzbd-svc"
      - "traefik.http.services.sabnzbd-svc.loadbalancer.server.port=8080"
      ## API ROUTER - Allow access to API without auth for 3rd party app access
      - "traefik.http.routers.sabnzbd-api-rtr.entrypoints=https"
      - "traefik.http.routers.sabnzbd-api-rtr.priority=100"
      - "traefik.http.routers.sabnzbd-api-rtr.rule=Host(`sabnzbd.$DOMAINNAME`) && (Headers(`X-Api-Key`, `$SABNZBD_API`) || Query(`apikey=$SABNZBD_API`))"
      - "traefik.http.routers.sabnzbd-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.sabnzbd-api-rtr.service=sabnzbd-svc"

############################# INDEXERS
# PROWLARR - NZB/TOR Proxy Search
  prowlarr:
    <<: *common-keys-apps
    image: linuxserver/prowlarr:develop
    container_name: prowlarr
    profiles: ["media", "all"]
    environment:
      <<: *default-tz-puid-pgid
    volumes:
      - $DOCKERDIR/prowlarr/data:/config
#    ports:
#      - $PROWLARR_PORT:9696
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr-rtr.entrypoints=https"
      - "traefik.http.routers.prowlarr-rtr.priority=99"
      - "traefik.http.routers.prowlarr-rtr.rule=Host(`prowlarr.$DOMAINNAME`)"
      - "traefik.http.routers.prowlarr-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.prowlarr-rtr.service=prowlarr-svc"
      - "traefik.http.services.prowlarr-svc.loadbalancer.server.port=9696"
      # API ROUTER - Allow access to API without auth for 3rd party app access
      - "traefik.http.routers.prowlarr-api-rtr.entrypoints=https"
      - "traefik.http.routers.prowlarr-api-rtr.priority=100"
      - "traefik.http.routers.prowlarr-api-rtr.rule=Host(`prowlarr.$DOMAINNAME`) && (Headers(`X-Api-Key`, `$PROWLARR_API`) || Query(`apikey=$PROWLARR_API`))"
      - "traefik.http.routers.prowlarr-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.prowlarr-api-rtr.service=prowlarr-svc"

  flaresolverr:
    <<: *common-keys-apps
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    profiles: ["media", "all"]
    environment:
      <<: *default-tz-puid-pgid
      #LOG_LEVEL: ${LOG_LEVEL:-info}
      #LOG_HTML: ${LOG_HTML:-false}
      CAPTCHA_SOLVER: ${CAPTCHA_SOLVER:-none}
#    ports:
#      - "${PORT:-8191}:8191"


# NZBHydra2 - NZB meta search
  hydra:
    <<: *common-keys-apps
    image: linuxserver/nzbhydra2
    container_name: hydra
    profiles: ["media", "all"]
#    ports:
#      - "$NZBHYDRA_PORT:5076"
    volumes:
      - $DOCKERDIR/hydra2:/config
      - $DOWNLOAD_DIR:/downloads
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hydra-rtr.entrypoints=https"
      - "traefik.http.routers.hydra-rtr.rule=Host(`hydra.$DOMAINNAME`)"
      - "traefik.http.routers.hydra-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.hydra-rtr.service=hydra-svc"
      - "traefik.http.services.hydra-svc.loadbalancer.server.port=5076"

############################# PVRS

# Lidarr - Music Management
  lidarr:
    <<: *common-keys-apps
    image: linuxserver/lidarr
    container_name: lidarr
    profiles: ["media", "all"]
#    ports:
#      - "$LIDARR_PORT:8686"
    volumes:
      - $DOCKERDIR/lidarr:/config
      - $DOWNLOAD_DIR:/downloads
      - $USERDIR/media/music:/music
      - "/etc/localtime:/etc/localtime:ro"
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lidarr-rtr.entrypoints=https"
      - "traefik.http.routers.lidarr-rtr.priority=99"
      - "traefik.http.routers.lidarr-rtr.rule=Host(`lidarr.$DOMAINNAME`)"
      - "traefik.http.routers.lidarr-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.lidarr-rtr.service=lidarr-svc"
      - "traefik.http.services.lidarr-svc.loadbalancer.server.port=8686"
      ## API ROUTER - Allow access to API without auth for 3rd party app access
      - "traefik.http.routers.lidarr-api-rtr.entrypoints=https"
      - "traefik.http.routers.lidarr-api-rtr.priority=100"
      - "traefik.http.routers.lidarr-api-rtr.rule=Host(`lidarr.$DOMAINNAME`) && (Headers(`X-Api-Key`, `$LIDARR_API`) || Query(`apikey=$LIDARR_API`))"
      - "traefik.http.routers.lidarr-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.lidarr-api-rtr.service=lidarr-svc"

# Radarr - Movie management
  radarr:
    <<: *common-keys-apps
    image: linuxserver/radarr:nightly
    container_name: radarr
    profiles: ["media", "all"]
#    ports:
#      - "$RADARR_PORT:7878"
    volumes:
      - $DOCKERDIR/radarr:/config
      - $DOWNLOAD_DIR:/downloads
      - $USERDIR/media/movies:/movies
      - $USERDIR/media/kidsmovies:/kidsmovies
      - "/etc/localtime:/etc/localtime:ro"
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.radarr-rtr.entrypoints=https"
      - "traefik.http.routers.radarr-rtr.priority=99"
      - "traefik.http.routers.radarr-rtr.rule=Host(`radarr.$DOMAINNAME`)"
      - "traefik.http.routers.radarr-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.radarr-rtr.service=radarr-svc"
      - "traefik.http.services.radarr-svc.loadbalancer.server.port=7878"
      ## API ROUTER - Allow access to API without auth for 3rd party app access
      - "traefik.http.routers.radarr-api-rtr.entrypoints=https"
      - "traefik.http.routers.radarr-api-rtr.priority=100"
      - "traefik.http.routers.radarr-api-rtr.rule=Host(`radarr.$DOMAINNAME`) && (Headers(`X-Api-Key`, `$RADARR_API`) || Query(`apikey=$RADARR_API`))"
      - "traefik.http.routers.radarr-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.radarr-api-rtr.service=radarr-svc"

# Sonarr - TV Shows management
  sonarr:
    <<: *common-keys-apps
    image: linuxserver/sonarr:develop
    container_name: sonarr
    profiles: ["media", "all"]
#    ports:
#      - "$SONARR_PORT:8989"
    volumes:
      - $DOCKERDIR/sonarr:/config
      - $DOWNLOAD_DIR:/downloads
      - $USERDIR/media/tvshows:/tv
      - "/etc/localtime:/etc/localtime:ro"
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr-rtr.entrypoints=https"
      - "traefik.http.routers.sonarr-rtr.priority=99"
      - "traefik.http.routers.sonarr-rtr.rule=Host(`sonarr.$DOMAINNAME`)"
      - "traefik.http.routers.sonarr-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.sonarr-rtr.service=sonarr-svc"
      - "traefik.http.services.sonarr-svc.loadbalancer.server.port=8989"
      ## API ROUTER - Allow access to API without auth for 3rd party app access
      - "traefik.http.routers.sonarr-api-rtr.entrypoints=https"
      - "traefik.http.routers.sonarr-api-rtr.priority=100"
      - "traefik.http.routers.sonarr-api-rtr.rule=Host(`sonarr.$DOMAINNAME`) && (Headers(`X-Api-Key`, `$SONARR_API`) || Query(`apikey=$SONARR_API`))"
      - "traefik.http.routers.sonarr-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.sonarr-api-rtr.service=sonarr-svc"

# Book Manager and Automation
  readarr:
    <<: *common-keys-apps
    image: linuxserver/readarr:nightly
    container_name: readarr
    profiles: ["media", "all"]
    volumes:
      - $DOCKERDIR/readarr/config:/config:Z
      - $DOWNLOAD_DIR:/downloads
      - $USERDIR/media/books:/books
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.readarr-rtr.entrypoints=https"
      - "traefik.http.routers.readarr-rtr.priority=99"
      - "traefik.http.routers.readarr-rtr.rule=Host(`readarr.$DOMAINNAME`)"
      - "traefik.http.routers.readarr-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.readarr-rtr.service=readarr-svc"
      - "traefik.http.services.readarr-svc.loadbalancer.server.port=8787"
      # API ROUTER - Allow access to API without auth for 3rd party app access
      - "traefik.http.routers.readarr-api-rtr.entrypoints=https"
      - "traefik.http.routers.readarr-api-rtr.priority=100"
      - "traefik.http.routers.readarr-api-rtr.rule=Host(`READARR.$DOMAINNAME`) && (Headers(`X-Api-Key`, `$READARR_API`) || Query(`apikey=$READARR_API`))"
      - "traefik.http.routers.readarr-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.readarr-api-rtr.service=readarr-svc"

# Mylar - Comic Book management
  mylar:
    <<: *common-keys-apps
    image: linuxserver/mylar3
    container_name: mylar
    profiles: ["media", "all"]
#    ports:
#      - "$MYLAR_PORT:8090"
    volumes:
      - $DOCKERDIR/mylar:/config
      - $DOWNLOAD_DIR:/downloads
      - $USERDIR/media/comics:/comics
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mylar-rtr.entrypoints=https"
      - "traefik.http.routers.mylar-rtr.priority=99"
      - "traefik.http.routers.mylar-rtr.rule=Host(`mylar.$DOMAINNAME`)"
      - "traefik.http.routers.mylar-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.mylar-rtr.service=mylar-svc"
      - "traefik.http.services.mylar-svc.loadbalancer.server.port=8090"
      # API ROUTER - Allow access to API without auth for 3rd party app access
      - "traefik.http.routers.mylar-api-rtr.entrypoints=https"
      - "traefik.http.routers.mylar-api-rtr.priority=100"
      - "traefik.http.routers.mylar-api-rtr.rule=Host(`mylar.$DOMAINNAME`) && (Headers(`X-Api-Key`, `$MYLAR_API`) || Query(`apikey=$MYLAR_API`))"
      - "traefik.http.routers.mylar-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.mylar-api-rtr.service=mylar-svc"

# YouTube Downloader
  youtubedl:
    <<: *common-keys-apps
    image: tzahi12345/youtubedl-material:latest
    container_name: youtubedl
    profiles: ["media", "all"]
#    ports:
#     - "$YOUTUBEDLMATERIAL_PORT:17442"
    volumes:
      - $DOCKERDIR/youtubedl-material/config:/app/appdata
      - $DOWNLOAD_DIR/youtubedl-material/audio:/app/audio
      - $DOWNLOAD_DIR/youtubedl-material/video:/app/video
      - $DOWNLOAD_DIR/youtubedl-material/subscriptions:/app/subscriptions
      - $DOCKERDIR/youtubedl-material/users:/app/users
    environment:
      UID: $PUID
      GID: $PGID
    labels:
      - "traefik.enable=true"
      ## HTTP Routers
      - "traefik.http.routers.youtubedl-rtr.entrypoints=https"
      - "traefik.http.routers.youtubedl-rtr.rule=Host(`ytdl.$DOMAINNAME`)"
      ## Middlewares
      - "traefik.http.routers.youtubedl-rtr.middlewares=chain-oauth@file"
      ## HTTP Services
      - "traefik.http.routers.youtubedl-rtr.service=youtubedl-svc"
      - "traefik.http.services.youtubedl-svc.loadbalancer.server.port=17442"

#Notifiarr
  notifiarr:
    <<: *common-keys-apps
    image: golift/notifiarr
    container_name: notifiarr
    hostname: notifiarr
    profiles: ["media", "all"]
#    privileged: true
#    ports:
#      - "5454:5454"
    volumes:
      - $DOCKERDIR/notifiarr:/config
      - /var/run/utmp:/var/run/utmp
      - /etc/machine-id:/etc/machine-id
    environment:
      <<: *default-tz-puid-pgid
##      DN_UI_PASSWORD: $HTTP_PASSWORD
      DN_API_KEY: $NOTIFIARR_API
      DN_LIDARR_0_NAME: Lidarr.$DOMAINNAME
      DN_LIDARR_0_URL: http://lidarr:8686/lidarr
      DN_LIDARR_0_API_KEY: $LIDARR_API
      DN_PROWLARR_0_NAME: Prowlarr.$DOMAINNAME
      DN_PROWLARR_0_URL: http://prowlarr:9696
      DN_PROWLARR_0_API_KEY: $PROWLARR_API
#      DN_PROWLARR_0_USERNAME_FILE: /run/secrets/http_username #$HTTP_USERNAME
#      DN_PROWLARR_0_PASSWORD_FILE: /run/secrets/http_password #$HTTP_PASSWORD
      DN_RADARR_0_NAME: Radarr.$DOMAINNAME
      DN_RADARR_0_URL: http://radarr:7878/radarr
      DN_RADARR_0_API_KEY: $RADARR_API
      DN_READARR_0_NAME: Readarr.$DOMAINNAME
      DN_READARR_0_URL: http://readarr:8787
      DN_READARR_0_API_KEY: $READARR_API
      DN_SONARR_0_NAME: Sonarr.$DOMAINNAME
      DN_SONARR_0_URL: http://sonarr:8989/sonarr
      DN_SONARR_0_API_KEY: $SONARR_API
      DN_SABNZBD_0_NAME: Sabnzbd.$DOMAINNAME
      DN_SABNZBD_0_URL: https://sabnzbd:8080
      DN_SABNZBD_0_API_KEY: $SABNZBD_API
      DN_LIDARR_1_NAME: Lidarr2.$DOMAINNAME
      DN_LIDARR_1_URL: https://lidarr2.$DOMAINNAME/lidarr
      DN_LIDARR_1_API_KEY: $LIDARR_API
      DN_PROWLARR_1_NAME: Prowlarr2.$DOMAINNAME
      DN_PROWLARR_1_URL: https://prowlarr2.$DOMAINNAME
      DN_PROWLARR_1_API_KEY: $PROWLARR_API
#      DN_PROWLAR_1_USERNAME_FILE: /run/secrets/http_username #$HTTP_USERNAME
#      DN_PROWLAR_1_PASSWORD_FILE: /run/secrets/http_password #$HTTP_PASSWORD
      DN_RADARR_1_NAME: Radarr2.$DOMAINNAME
      DN_RADARR_1_URL: https://radarr2.$DOMAINNAME/radarr
      DN_RADARR_1_API_KEY: $RADARR_API
      DN_SONARR_1_NAME: Sonarr2.$DOMAINNAME
      DN_SONARR_1_URL: https://sonarr2.$DOMAINNAME/sonarr
      DN_SONARR_1_API_KEY: $SONARR_API
      DN_SABNZBD_1_NAME: Sabnzbd2.$DOMAINNAME
      DN_SABNZBD_1_URL: https://sabnzbd2.$DOMAINNAME
      DN_SABNZBD_1_API_KEY: $SABNZBD_API
      DN_LIDARR_2_NAME: Lidarr.$DOMAINNAME2
      DN_LIDARR_2_URL: https://lidarr.$DOMAINNAME2/lidarr
      DN_LIDARR_2_API_KEY: $LIDARR_API
      DN_PROWLARR_2_NAME: Prowlarr.$DOMAINNAME2
      DN_PROWLARR_2_URL: https://prowlarr.$DOMAINNAME2
      DN_PROWLARR_2_API_KEY: $PROWLARR_API
#      DN_PROWLAR_2_USERNAME_FILE: /run/secrets/http_username #$HTTP_USERNAME
#      DN_PROWLAR_2_PASSWORD_FILE: /run/secrets/http_password #$HTTP_PASSWORD
      DN_RADARR_2_NAME: Radarr.$DOMAINNAME2
      DN_RADARR_2_URL: https://radarr.$DOMAINNAME2/radarr
      DN_RADARR_2_API_KEY: $RADARR_API
      DN_SONARR_2_NAME: Sonarr.$DOMAINNAME2
      DN_SONARR_2_URL: https://sonarr.$DOMAINNAME2/sonarr
      DN_SONARR_2_API_KEY: $SONARR_API
      DN_SABNZBD_2_NAME: Sabnzbd.$DOMAINNAME2
      DN_SABNZBD_2_URL: https://sabnzbd.$DOMAINNAME2
      DN_SABNZBD_2_API_KEY: $SABNZBD_API
      DN_PLEX_URL: https://plex.$DOMAINNAME
#      DN_PLEX_TOKEN_FILE: /run/secrets/plex_token #$PLEX_TOKEN
      DN_TAUTULLI_NAME: Tautulli.$DOMAINNAME
      DN_TAUTULLI_URL: http://tautulli:8181
      DN_TAUTULLI_API_KEY: $TAUTULLI_API
#      HTTP_USERNAME_FILE: /run/secrets/http_username
#      HTTP_PASSWORD_FILE: /run/secrets/http_password
#      PLEX_TOKEN_FILE: /run/secrets/plex_token
    secrets:
      - http_username
      - http_password
      - plex_token
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.notifiarr-rtr.entrypoints=https"
      - "traefik.http.routers.notifiarr-rtr.priority=99"
      - "traefik.http.routers.notifiarr-rtr.rule=Host(`notifiarr.$DOMAINNAME`)"
      - "traefik.http.routers.notifiarr-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.notifiarr-rtr.service=notifiarr-svc"
      - "traefik.http.services.notifiarr-svc.loadbalancer.server.port=5454"
      # API ROUTER - Allow access to API without auth for 3rd party app access
      - "traefik.http.routers.notifiarr-api-rtr.entrypoints=https"
      - "traefik.http.routers.notifiarr-api-rtr.priority=100"
      - "traefik.http.routers.notifiarr-api-rtr.rule=Host(`notifiarr.$DOMAINNAME`) && (Headers(`X-Api-Key`, `$NOTIFIARR_API`) || Query(`apikey=$NOTIFIARR_API`))"
      - "traefik.http.routers.notifiarr-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.notifiarr-api-rtr.service=notifiarr-svc"

############################# MEDIA
  plex:
    <<: *common-keys-apps
    image: linuxserver/plex
    container_name: plex
    profiles: ["media", "all"]
    # runtime: nvidia
    environment:
      <<: *default-tz-puid-pgid
      PLEX_CLAIM_FILE: /run/secrets/plex_claim
      ADVERTISE_IP: http://$SERVER_IP:$PLEX_PORT/,https://plex.$DOMAINNAME/
      ALLOWED_NETWORKS: $IPWHITELIST
      VERSION: docker
      # NVIDIA_VISIBLE_DEVICES: all
      # NVIDIA_DRIVER_CAPABILITIES: compute,video,utility
    devices:
      - /dev/dri:/dev/dri
    secrets:
      - plex_claim
    hostname: plex
    networks:
      t2_proxy:
    ports:
      - $PLEX_PORT:32400/tcp
      - 3005:3005/tcp
      - 8324:8324/tcp
      - 32469:32469/tcp
      - 1900:1900/udp
      - 32410:32410/udp
      - 32412:32412/udp
      - 32413:32413/udp
      - 32414:32414/udp
    volumes:
#      - $USERDIR/plexdrive/PlexTranscode:/transcode
      - $USERDIR/plexdrive/PlexPreRoll:/PlexPreRoll
      - $USERDIR/media:/media
      - $DOCKERDIR/Plex/DB:/config
      - /dev/shm:/transcode
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.plex-rtr.entrypoints=https"
      - "traefik.http.routers.plex-rtr.rule=Host(`plex.$DOMAINNAME`)"
      - "traefik.http.routers.plex-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.plex-rtr.service=plex-svc"
      - "traefik.http.services.plex-svc.loadbalancer.server.port=32400"

#Plex Meta Manager - Automatic Metadata Manager for Plex
  plexmm:
    <<: *common-keys-apps
    image: linuxserver/kometa
    container_name: plexmm
    profiles: ["plexmm"]
    depends_on:
      - plex
    environment:
      <<: *default-tz-puid-pgid
      KOMETA_CONFIG: /config/config.yml #optional
      KOMETA_TIMES: 05:00 #optional
#      KOMETA_RUN: "True" #optional
      KOMETA_TEST: "False" #optional
      KOMETA_NO_MISSING: "False" #optional
      KOMETA_FILE_PLEX_TOKEN: /run/secrets/plex_token
      KOMETA_FILE_TRAKT_CLIENTID: /run/secrets/trakt_clientid #$TRAKT_CLIENTID
      KOMETA_FILE_TRAKT_CLIENTSECRET: /run/secrets/trakt_clientsecret #$TRAKT_CLIENTSECRET
      KOMETA_FILE_TRAKT_PIN: /run/secrets/trakt_pin #$TRAKT_PIN
      KOMETA_FILE_GITHUB_TOKEN: /run/secrets/github_token #$GITHUB_TOKEN
      KOMETA_FILE_RADARR_API: /run/secrets/radarr_api #$RADARR_API
      KOMETA_FILE_SONARR_API: /run/secrets/sonarr_api #$SONARR_API
      KOMETA_FILE_MDBLIST_API: /run/secrets/mdblist_api #$MDBLIST_API
      KOMETA_FILE_OMDB_API: /run/secrets/omdb_api #$OMDB_API
      KOMETA_FILE_TMDB_API: /run/secrets/tmdb_api #$TMDB_API
      KOMETA_FILE_TAUTULLI_API: /run/secrets/tautulli_api #$TAUTULLI_API
      KOMETA_FILE_NOTIFIARR_API: /run/secrets/notifiarr_api
      KOMETA_VAR_SERVER_IP: $SERVER_IP
      KOMETA_VAR_PLEX_PORT: $PLEX_PORT
    volumes:
      - $DOCKERDIR/plex-meta-manager/config:/config:rw
    secrets:
      - plex_token
      - trakt_clientid
      - trakt_clientsecret
      - trakt_pin
      - github_token
      - sonarr_api
      - radarr_api
      - mdblist_api
      - omdb_api
      - tmdb_api
      - tautulli_api
      - notifiarr_api

#Plex Image Cleanup
  plexic:
    <<: *common-keys-apps
    image: meisnate12/plex-image-cleanup
    container_name: plexic
    profiles: ["media", "all"]
    depends_on:
      - plex
    environment:
      <<: *default-tz-puid-pgid
      PLEX_PATH: /plex
      MODE: remove
      SCHEDULE: "07:00|weekly(sunday)"
      PLEX_URL: http://$SERVER_IP:$PLEX_PORT
      PLEX_TOKEN: /run/secrets/plex_token
      #DISCORD=https://discord.com/api/webhooks/###################/####################################################################
      TIMEOUT: 600
      SLEEP: 60
      IGNORE_RUNNING: True
      LOCAL_DB: False
      USE_EXISTING: False
      PHOTO_TRANSCODER: False
      EMPTY_TRASH: True
      CLEAN_BUNDLES: True
      OPTIMIZE_DB: True
      TRACE: False
      LOG_REQUESTS: True
    secrets:
      - plex_token
    volumes:
      - $DOCKERDIR/plex-image-cleanup/config:/config
      - $DOCKERDIR/Plex/DB/Library/Application Support/Plex Media Server:/plex

# Logitech Media Server - Music Server
  lms:
    <<: *common-keys-apps
    image: reddthebamf/lms:8.4.0
    container_name: lms
#    image: larsks/logitech-media-server
    profiles: ["media", "all"]
    ports:
      - "$LMS_PORT1:9000"
      - "$LMS_PORT2:9090"
      - "$LMS_PORT3:3483"
      - "$LMS_PORT3:3483/udp"
    volumes:
      - $USERDIR/media/music:/srv/music:ro
      - $DOCKERDIR/squeezebox:/srv/squeezebox
      - /etc/localtime:/etc/localtime:ro
    environment:
      <<: *default-tz-puid-pgid
      JAVA_OPTS: -Dserver.use-forward-headers=true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lms-rtr.entrypoints=https"
      - "traefik.http.routers.lms-rtr.rule=Host(`lms.$DOMAINNAME`)"
      - "traefik.http.routers.lms-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.lms-rtr.service=lms-svc"
      - "traefik.http.services.lms-svc.loadbalancer.server.port=9000"

# Ombi - Media Requests
  ombi:
    image: linuxserver/ombi
    container_name: ombi
    networks:
      - default
      - t2_proxy
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["media", "all"]
#    ports:
#      - "$OMBI_PORT:3579"
    volumes:
      - $DOCKERDIR/ombi:/config
    environment:
      <<: *default-tz-puid-pgid
      BASE_URL: /ombi #optional
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ombi-rtr.entrypoints=https"
      - "traefik.http.routers.ombi-rtr.priority=99"
      - "traefik.http.routers.ombi-rtr.rule=Host(`ombi.$DOMAINNAME`)"
      - "traefik.http.routers.ombi-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.ombi-rtr.service=ombi-svc"
      - "traefik.http.services.ombi-svc.loadbalancer.server.port=3579"
      ## API Oauth Bypass
      - "traefik.http.routers.ombi-api-rtr.entrypoints=https"
      - "traefik.http.routers.ombi-api-rtr.rule=Host(`ombi.$DOMAINNAME`) && PathPrefix(`/api/`)"
      - "traefik.http.routers.ombi-api-rtr.priority=100"
      - "traefik.http.routers.ombi-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.ombi-api-rtr.service=ombi-svc"

# Tautulli - Plex statistics and monitoring
  tautulli:
    <<: *common-keys-apps
    image: linuxserver/tautulli
    container_name: tautulli
    profiles: ["media", "all"]
#    ports:
#      - "$TAUTULLI_PORT:8181"
    volumes:
      - $DOCKERDIR/tautulli/config:/config
      - $DOCKERDIR/tautulli/logs:/logs:ro
    environment:
      <<: *default-tz-puid-pgid
    depends_on:
      - plex
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tautulli-rtr.entrypoints=https"
      - "traefik.http.routers.tautulli-rtr.priority=99"
      - "traefik.http.routers.tautulli-rtr.rule=Host(`tautulli.$DOMAINNAME`)"
      - "traefik.http.routers.tautulli-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.tautulli-rtr.service=tautulli-svc"
      - "traefik.http.services.tautulli-svc.loadbalancer.server.port=8181"
      ## API Oauth Bypass
      - "traefik.http.routers.tautulli-api-rtr.entrypoints=https"
      - "traefik.http.routers.tautulli-api-rtr.rule=Host(`tautulli.$DOMAINNAME`) && (Headers(`X-Api-Key`, `$TAUTULLI_DEVICE_KEY`) || Headers(`X-Api-Key`, `$TAUTULLI_API`) || Query(`apikey=$TAUTULLI_DEVICE_KEY`) || Query(`apikey=$TAUTULLI_API`))"
      - "traefik.http.routers.tautulli-api-rtr.priority=100"
      - "traefik.http.routers.tautulli-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.tautulli-api-rtr.service=tautulli-svc"

############################# MEDIA FILE MANAGEMENT

# Bazarr - Subtitle Management
  bazarr:
    <<: *common-keys-apps
    image: linuxserver/bazarr
    container_name: bazarr
    profiles: ["media", "all"]
#    ports:
#      - "$BAZARR_PORT:6767"
    volumes:
      - $DOCKERDIR/bazarr:/config
      - $USERDIR/media/movies:/movies
      - $USERDIR/media/tvshows:/tv
      - $USERDIR/media/kidsmovies:/kidsmovies
    environment:
      <<: *default-tz-puid-pgid
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bazarr-rtr.entrypoints=https"
      - "traefik.http.routers.bazarr-rtr.priority=99"
      - "traefik.http.routers.bazarr-rtr.rule=Host(`bazarr.$DOMAINNAME`)"
      - "traefik.http.routers.bazarr-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.bazarr-rtr.service=bazarr-svc"
      - "traefik.http.services.bazarr-svc.loadbalancer.server.port=6767"
      ## API ROUTER - Allow access to API without auth for 3rd party app access
      - "traefik.http.routers.bazarr-api-rtr.entrypoints=https"
      - "traefik.http.routers.bazarr-api-rtr.priority=100"
      - "traefik.http.routers.bazarr-api-rtr.rule=Host(`bazarr.$DOMAINNAME`) && (Headers(`X-Api-Key`, `$BAZARR_API`) || Query(`apikey=$BAZARR_API`))"
      - "traefik.http.routers.bazarr-api-rtr.middlewares=chain-no-auth@file"
      - "traefik.http.routers.bazarr-api-rtr.service=bazarr-svc"

# # Picard - Music Library Tagging and Management
#   picard:
#     <<: *common-keys-apps
#     image: mikenye/picard
#     container_name: picard
#     profiles: ["avedit", "all"]
# #    ports:
# #      - "$PICARD_PORT:5800"
#     volumes:
#       - $DOWNLOAD_DIR/wip_media:/wip_media:rw
#       - $DOCKERDIR/picard:/config:rw
#       - $USERDIR/media/music:/music:rw
#       - /dev/shm:/dev/shm
#     environment:
#       <<: *default-tz-puid-pgid
#       UMASK: 002
#       DISPLAY_WIDTH: 1600
#       DISPLAY_HEIGHT: 960
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.picard-rtr.entrypoints=https"
#       - "traefik.http.routers.picard-rtr.rule=Host(`picard.$DOMAINNAME`)"
#       - "traefik.http.routers.picard-rtr.middlewares=chain-oauth@file"
#       - "traefik.http.routers.picard-rtr.service=picard-svc"
#       - "traefik.http.services.picard-svc.loadbalancer.server.port=5800"

# Handbrake - Video Conversion (Transcoding and compression)
  handbrake:
    <<: *common-keys-apps
    image: jlesage/handbrake
    container_name: handbrake
    profiles: ["avedit", "all"]
#    ports:
#      - "$HANDBRAKE_PORT:5800"
    volumes:
      - $DOWNLOAD_DIR:/downloads:ro
      - $USERDIR/media:/media:rw
      - $DOCKERDIR/handbrake/config:/config:rw
      - $DOCKERDIR/handbrake/watch:/watch:rw
      - $DOWNLOAD_DIR/wip_media:/output:rw
      - $USERDIR/media/storage:/base_storage:rw
    environment:
      <<: *default-tz-puid-pgid
      UMASK: 002
      KEEP_APP_RUNNING: 1
      CLEAN_TMP_DIR: 1
      DISPLAY_WIDTH: 1600
      DISPLAY_HEIGHT: 960
      AUTOMATED_CONVERSION_KEEP_SOURCE: 1
    devices:
      - /dev/dri:/dev/dri
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.handbrake-rtr.entrypoints=https"
      - "traefik.http.routers.handbrake-rtr.rule=Host(`handbrake.$DOMAINNAME`)"
      - "traefik.http.routers.handbrake-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.handbrake-rtr.service=handbrake-svc"
      - "traefik.http.services.handbrake-svc.loadbalancer.server.port=5800"

# MKVToolNix - Video Editing (Remuxing - changing media container while keeping original source quality)
  mkvtoolnix:
    <<: *common-keys-apps
    image: jlesage/mkvtoolnix
    container_name: mkvtoolnix
    profiles: ["avedit", "all"]
#    ports:
#      - "$MKVTOOLNIX_PORT:5800"
    volumes:
      - $USERDIR/media:/media:rw
      - $DOWNLOAD_DIR:/downloads:rw
      - $DOCKERDIR/mkvtoolnix/config:/config:rw
      - $USERDIR/media/storage:/base_storage:rw
    environment:
      <<: *default-tz-puid-pgid
      UMASK: 002
      KEEP_APP_RUNNING: 1
      CLEAN_TMP_DIR: 1
      DISPLAY_WIDTH: 1600
      DISPLAY_HEIGHT: 960
      DARK_MODE: 1
    devices:
      - /dev/dri:/dev/dri
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mkvtoolnix-rtr.entrypoints=https"
      - "traefik.http.routers.mkvtoolnix-rtr.rule=Host(`mkvtoolnix.$DOMAINNAME`)"
      - "traefik.http.routers.mkvtoolnix-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.mkvtoolnix-rtr.service=mkvtoolnix-svc"
      - "traefik.http.services.mkvtoolnix-svc.loadbalancer.server.port=5800"

# # MKVcleaver is a GUI (Graphical User Interface) for mkvtoolnix, designed to extract data from MKV files.
#   mkvcleaver:
#     <<: *common-keys-apps
#     image: jlesage/mkvcleaver
#     container_name: mkvcleaver
#     profiles: ["avedit"]
# #    ports:
# #      - "$MKVCLEAVER_PORT:5800"
#     volumes:
#       - $USERDIR/media:/media:rw
#       - $DOWNLOAD_DIR:/downloads:rw
#       - $DOCKERDIR/mkvcleaver/config:/config:rw
#       - $USERDIR/media/storage:/base_storage:rw
#     environment:
#       <<: *default-tz-puid-pgid
#       UMASK: 002
#       KEEP_APP_RUNNING: 1
#       CLEAN_TMP_DIR: 1
#       DISPLAY_WIDTH: 1600
#       DISPLAY_HEIGHT: 960
#       DARK_MODE: 1
#     devices:
#       - /dev/dri:/dev/dri
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.mkvcleaver-rtr.entrypoints=https"
#       - "traefik.http.routers.mkvcleaver-rtr.rule=Host(`mkvcleaver.$DOMAINNAME`)"
#       - "traefik.http.routers.mkvcleaver-rtr.middlewares=chain-oauth@file"
#       - "traefik.http.routers.mkvcleaver-rtr.service=mkvcleaver-svc"
#       - "traefik.http.services.mkvcleaver-svc.loadbalancer.server.port=5800"

# # MakeMKV - Video Editing (Ripping from Disks)
#   makemkv:
#     <<: *common-keys-apps
#     image: jlesage/makemkv
#     container_name: makemkv
#     profiles: ["avedit", "all"]
# #    ports:
# #      - "$MAKEMKV_PORT:5800"
#     volumes:
#       - $USERDIR/media:/media:rw
#       - $DOWNLOAD_DIR:/downloads:rw
#       - $DOCKERDIR/makemkv/config:/config:rw
#       - $USERDIR/media/storage:/storage:rw
#       - /mnt/cdrom:/mnt/cdrom
#     environment:
#       <<: *default-tz-puid-pgid
#       UMASK: 002
#       KEEP_APP_RUNNING: 1
#       CLEAN_TMP_DIR: 1
#       DISPLAY_WIDTH: 1600
#       DISPLAY_HEIGHT: 960
#     devices:
#       - /dev/dri:/dev/dri
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.makemkv-rtr.entrypoints=https"
#       - "traefik.http.routers.makemkv-rtr.rule=Host(`makemkv.$DOMAINNAME`)"
#       - "traefik.http.routers.makemkv-rtr.middlewares=chain-oauth@file"
#       - "traefik.http.routers.makemkv-rtr.service=makemkv-svc"
#       - "traefik.http.services.makemkv-svc.loadbalancer.server.port=5800"

############################# UTILITIES

# Glances - System Information
  glances:
    <<: *common-keys-apps
    image: nicolargo/glances
    container_name: glances
    profiles: ["infra", "all"]
    privileged: true
#    ports:
#      - "$GLANCES_PORT:61208"
    pid: host
    volumes:
      - $DOCKERDIR/glances/glances.conf:/glances/conf/glances.conf # Use this if you want to add a glances.conf file
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      <<: *default-tz-puid-pgid
#      GLANCES_OPT: "-C /glances/conf/glances.conf --quiet --export influxdb"
      GLANCES_OPT: "-w --password"
    secrets:
      - source: glances_password
        target: /root/.config/glances/glances.pwd
    labels:
      - "traefik.enable=true"
      ## HTTP Routers
      - "traefik.http.routers.glances-rtr.entrypoints=https"
      - "traefik.http.routers.glances-rtr.rule=Host(`glances.$DOMAINNAME`)"
      - "traefik.http.routers.glances-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.glances-rtr.service=glances-svc"
      - "traefik.http.services.glances-svc.loadbalancer.server.port=61208"

# Dozzle - Real-time Docker Log Viewer
  dozzle:
    <<: *common-keys-apps
    image: amir20/dozzle
    container_name: dozzle
    profiles: ["infra", "all"]
#    ports:
#      - "$DOZZLE_PORT:8080"
    environment:
      <<: *default-tz-puid-pgid
      DOZZLE_LEVEL: info
#      DOZZLE_TAILSIZE: 300
      DOZZLE_FILTER: "status=running"
      DOZZLE_NO_ANALYTICS: 1
#      DOZZLE_FILTER: "label=log_me" # limits logs displayed to containers with this label
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dozzle-rtr.entrypoints=https"
      - "traefik.http.routers.dozzle-rtr.rule=Host(`dozzle.$DOMAINNAME`)"
      - "traefik.http.routers.dozzle-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.dozzle-rtr.service=dozzle-svc"
      - "traefik.http.services.dozzle-svc.loadbalancer.server.port=8080"

# WatchTower - Automatic Docker Container Updates
  watchtower:
    <<: *common-keys-apps
    image: containrrr/watchtower
    container_name: watchtower
    profiles: ["infra", "all"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Use Docker Socket Proxy and comment this line for improved security.
    environment:
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_REMOVE_VOLUMES: "true"
      WATCHTOWER_INCLUDE_STOPPED: "true"
      WATCHTOWER_NO_STARTUP_MESSAGE: "false"
      WATCHTOWER_SCHEDULE: "0 30 12 * * *" # Everyday at 12:30
      # DOCKER_HOST: tcp://socket-proxy:2375 # Use this if you have Socket Proxy enabled.
      DOCKER_API_VERSION: "1.43"

# Docker-GC - Automatic Docker Garbage Collection 
# Create docker-gc-exclude file
  dockergc:
    <<: *common-keys-apps
    image: reddthebamf/docker-gc-cron
    container_name: docker-gc
    profiles: ["infra", "all"]
#    network_mode: none
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - $DOCKERDIR/docker-gc/docker-gc-exclude:/etc/docker-gc-exclude
    environment:
      <<: *default-tz-puid-pgid
      CRON: 0 0 0 * * ?
      FORCE_IMAGE_REMOVAL: 1
      FORCE_CONTAINER_REMOVAL: 0
      GRACE_PERIOD_SECONDS: 604800
      DRY_RUN: 0
      CLEAN_UP_VOLUMES: 1

# Traefik Certs Dumper - Extract LetsEncrypt Certificates - Traefik2 Compatible
  certdumper:
    <<: *common-keys-apps
    image: humenius/traefik-certs-dumper #kereis/traefik-certs-dumper:multi-arch-builds-alpine
    container_name: traefik_certdumper
    profiles: ["infra", "all"]
#    command: --restart-containers container1,container2,container3
    volumes:
      - $DOCKERDIR/traefik/acme:/traefik:ro
      - $DOCKERDIR/shared/certs:/output:rw
#    - /var/run/docker.sock:/var/run/docker.sock:ro # only needed if restarting containers
    environment:
      <<: *default-tz-puid-pgid
      DOMAIN: $DOMAINNAME

## HomeAssistant - Smart Home Hub
#  homeassistant:
#    <<: *common-keys-apps
#    image: homeassistant/home-assistant
#    container_name: homeassistant
#    profiles: ["infra", "all"]
##    ports:
##     - "$HASS_PORT:8123"
#    tty: true
#    volumes:
#      - $DOCKERDIR/homeassistant:/config
#      - /etc/localtime:/etc/localtime:ro
#      - $DOCKERDIR/shared:/shared
#    environment:
#      <<: *default-tz-puid-pgid
#    labels:
#      - "traefik.enable=true"
#      - "traefik.http.routers.homeassistant-rtr.entrypoints=https"
#      - "traefik.http.routers.homeassistant-rtr.rule=Host(`hass.$DOMAINNAME`)"
#      - "traefik.http.routers.homeassistant-rtr.middlewares=chain-no-auth@file"
#      - "traefik.http.routers.homeassistant-rtr.service=homeassistant-svc"
#      - "traefik.http.services.homeassistant-svc.loadbalancer.server.port=8123"

#NextCloud - Cloud based File Storage
  nextcloud:
    image: linuxserver/nextcloud:latest
    container_name: nextcloud
    networks:
      - default
      - t2_proxy
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
    volumes:
      - $DOCKERDIR/nextcloud/data/config:/config
      - $DOCKERDIR/nextcloud/data:/data
      - $DOCKERDIR/nextcloud/data:/var/www/html
      - $USERDIR/media/pictures:/data/media/pictures:rw
      - $USERDIR/media/storage/Documents:/data/media/Documents:rw
    environment:
      <<: *default-tz-puid-pgid
      REDIS_HOST: nc-redis
      NEXTCLOUD_DOMAIN_NAME: nextcloud.$DOMAINNAME
      NEXTCLOUD_TRUSTED_DOMAIN: nextcloud.$DOMAINNAME
      TRUSTED_PROXIES: $TRAEFIK_NETWORK
      FILE__MYSQL_DATABASE: /run/secrets/nc_db_name
      FILE__MYSQL_USER: /run/secrets/nc_db_user
      FILE__MYSQL_PASSWORD: /run/secrets/nc_db_password
      MYSQL_HOST: $MARIADB_HOST
      MYSQL_PORT: $MARIADB_PORT
      NEXTCLOUD_DATA_DIR: /var/www/html/data
      FILE__NEXTCLOUD_ADMIN_USER: /run/secrets/nc_admin_user
      FILE__NEXTCLOUD_ADMIN_PASSWORD: /run/secrets/nc_admin_password
    secrets:
      - nc_admin_password
      - nc_admin_user
      - nc_db_name
      - nc_db_user
      - nc_db_password
    depends_on:
      - nc-redis
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.entrypoints=https"
      - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.$DOMAINNAME`)"
      - "traefik.http.routers.nextcloud.middlewares=chain-nextcloud@file"
      - "traefik.http.routers.nextcloud.service=nextcloud"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"

  nc-redis:
    <<: *common-keys-apps
    image: redis:alpine
    container_name: nc-redis
    hostname: nc-redis
    profiles: ["infra", "all"]
    environment:
      <<: *default-tz-puid-pgid
#      ENABLE_OVERCOMMIT_MEMORY: "true"

# Firefox - Web Broswer
  firefox:
    <<: *common-keys-apps
    image: jlesage/firefox:latest
    container_name: firefox
    security_opt:
      - seccomp:unconfined # October 15, 2020 https://github.com/jlesage/docker-firefox/blob/master/README.md#allowing-the-membarrier-system-call
    profiles: ["ff"]
    # ports:
    #   - "$FIREFOX_PORT:5800"
    volumes:
      - $DOCKERDIR/firefox:/config
      - $DOWNLOAD_DIR:/data/downloads
      - /dev/shm:/dev/shm
    environment:
      <<: *default-tz-puid-pgid
      UMASK: 002
      KEEP_APP_RUNNING: 1
      CLEAN_TMP_DIR: 1
      DISPLAY_WIDTH: 1920
      DISPLAY_HEIGHT: 1080
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.firefox-rtr.entrypoints=https"
      - "traefik.http.routers.firefox-rtr.rule=Host(`firefox.$DOMAINNAME`)"
      - "traefik.http.routers.firefox-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.firefox-rtr.service=firefox-svc"
      - "traefik.http.services.firefox-svc.loadbalancer.server.port=5800"

# #TESLAMATE - TeslaMate Logging for Tesla        
#   teslamate:
#     <<: *common-keys-apps
#     image: teslamate/teslamate
#     container_name: teslamate
#     profiles: ["infra", "all"]
#     depends_on:
#       - postgres
#     environment:
#       <<: *default-tz-puid-pgid
#       ENCRYPTION_KEY: $TESLAMATE_EK
#       DATABASE_USER: $TESLAMATE_DB_USER
#       DATABASE_PASS: $TESLAMATE_DB_PASS
#       DATABASE_NAME: $TESLAMATE_DB
# #      ENCRYPTION_KEY__FILE: /run/secrets/teslamate_ek
# #      DATABASE_USER__FILE: /run/secrets/teslamate_db_user
# #      DATABASE_PASS__FILE: /run/secrets/teslamate_db_password
# #      DATABASE_NAME__FILE: /run/secrets/teslamate_db_name
#       DATABASE_HOST: postgres
#       MQTT_HOST: mosquitto
#       VIRTUAL_HOST: teslamate.$DOMAINNAME
#       CHECK_ORIGIN: "true"
# #    secrets:
# #      - teslamate_db_name
# #      - teslamate_db_user
# #      - teslamate_db_password
# #      - teslamate_ek
# #    ports:
# #      - "$TM_PORT:4000"
#     volumes:
#       - $DOCKERDIR/teslamate/import:/opt/app/import
#     cap_drop:
#       - all
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.teslamate-rtr.entrypoints=https"
#       - "traefik.http.routers.teslamate-rtr.rule=Host(`teslamate.$DOMAINNAME`)"
#       - "traefik.http.routers.teslamate-rtr.middlewares=chain-oauth@file"
#       - "traefik.http.routers.teslamate-rtr.service=teslamate-svc"
#       - "traefik.http.services.teslamate-svc.loadbalancer.server.port=4000"

# # Grafana - TeslaMate
#   grafanatm:
#     <<: *common-keys-apps
#     image: teslamate/grafana
#     container_name: grafanatm
#     profiles: ["infra", "all"]
#     environment:
#       <<: *default-tz-puid-pgid
#       DATABASE_HOST: postgres
#       GRAFANA_PASSWD__FILE: /run/secrets/grafana_pw
# #      GF_SECURITY_ADMIN_USER__FILE: /run/secrets/grafana_admin_user
# #      GF_SECURITY_ADMIN_PASSWORD__FILE: /run/secrets/grafana_admin_pw
#       GF_AUTH_ANONYMOUS_ENABLED: "false"
#       GF_AUTH_BASIC_ENABLED: "true"
#       GF_SERVER_ROOT_URL: "https://grafanatm.$DOMAINNAME"
#       GF_SERVER_SERVE_FROM_SUB_PATH: "false"
#       GF_AUTH_PROXY_ENABLED: "true"
#       GF_AUTH_PROXY_HEADER_NAME: "X-WEBAUTH-USER"
#       GF_AUTH_PROXY_HEADER_PROPERTY: "username"
#       GF_AUTH_PROXY_AUTO_SIGN_UP: "true"
#       GF_AUTH_PROXY_LDAP_SYNC_TTL: 60
#       GF_AUTH_PROXY_WHITELIST: "$IPWHITELIST"
#       GF_AUTH_PROXY_HEADERS: "Email:X-User-Email, Name:X-User-Name"
#       DATABASE_NAME__FILE: /run/secrets/teslamate_db_name
#       DATABASE_USER__FILE: /run/secrets/teslamate_db_user
#       DATABASE_PASS__FILE: /run/secrets/teslamate_db_password
#     secrets:
#       - teslamate_db_name
#       - teslamate_db_user
#       - teslamate_db_password
# #      - grafana_admin_user
#       - grafana_pw
# #      - grafana_admin_pw
#     volumes:
#       - $DOCKERDIR/grafanatm/grafana.ini:/etc/grafana/grafana.ini
#       - teslamate-grafana-data:/var/lib/grafana
# #    ports:
# #      - "$GRAFANATM_PORT:3000"
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.grafanatm-rtr.entrypoints=https"
#       - "traefik.http.routers.grafanatm-rtr.rule=Host(`grafanatm.$DOMAINNAME`)"
#       - "traefik.http.routers.grafanatm-rtr.middlewares=chain-oauth@file"
#       - "traefik.http.routers.grafanatm-rtr.service=grafanatm-svc"
#       - "traefik.http.services.grafanatm-svc.loadbalancer.server.port=3000"

#   posterr:
#     <<: *common-keys-apps
#     image: petersem/posterr
#     container_name: posterr
#     profiles: ["media", "all"]
#     ports:
#       - $POSTERR_PORT:3000
#     environment:
#       <<: *default-tz-puid-pgid
# #      BASEPATH: ""
#     volumes:
#       - $DOCKERDIR/posterr/config:/usr/src/app/config
#       - $DOCKERDIR/posterr/custom:/usr/src/app/public/custom

# VSCode - VSCode Editing
  vscode:
    <<: *common-keys-apps
    image: lscr.io/linuxserver/code-server:latest
    container_name: vscode
    profiles: ["infra", "all"]
#    ports:
#      - "8443:8443"
    volumes:
      - $DOCKERDIR:/data/docker
      - $USERDIR:/data/server
#      - $DATADIR:/data/data
      - $DOCKERDIR/vscode:/config
    environment:
      <<: *default-tz-puid-pgid
      # DOCKER_HOST: tcp://socket-proxy:2375
      # PASSWORD: $VSCODE_PASSWORD
      # HASHED_PASSWORD: #optional
      # SUDO_PASSWORD: password #optional
      # SUDO_PASSWORD_HASH: #optional
      # PROXY_DOMAIN: code-server.my.domain #optional
#      DEFAULT_WORKSPACE: /config/data/User/Workspaces/AZ.code-workspace #optional
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vscode-rtr.entrypoints=https"
      - "traefik.http.routers.vscode-rtr.rule=Host(`code.$DOMAINNAME`)"
      - "traefik.http.routers.vscode-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.vscode-rtr.service=vscode-svc"
      - "traefik.http.services.vscode-svc.loadbalancer.server.port=8443"

  whoami:
    image: traefik/whoami
    container_name: whoami
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["infra", "all"]
    networks:
      - t2_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami-rtr.entrypoints=https"
      - "traefik.http.routers.whoami-rtr.rule=Host(`whoami.$DOMAINNAME`)"
      - "traefik.http.routers.whoami-rtr.middlewares=chain-oauth@file"
      - "traefik.http.routers.whoami-rtr.service=whoami-svc"
      - "traefik.http.services.whoami-svc.loadbalancer.server.port=80"

# # NetbootXYZ PXE Boot Service
#   netbootxyz:
#     <<: *common-keys-core
#     image: lscr.io/linuxserver/netbootxyz:latest
#     container_name: netbootxyz
#     profiles: ["infra","all"]
#     environment:
#       <<: *default-tz-puid-pgid
# #      MENU_VERSION: 1.9.9
#       PORT_RANGE: 30000:30010
#       SUBFOLDER: /
#     volumes:
#       - $DOCKERDIR/netbootxyz/config:/config
#       - $DOCKERDIR/netbootxyz/assets:/assets #optional
#     ports:
#       - 3000:3000
#       - 69:69/udp
# #      - 8080:80 #optional
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.netbootxyz-rtr.entrypoints=https"
#       - "traefik.http.routers.netbootxyz-rtr.rule=Host(`netbootxyz.$DOMAINNAME`)"
#       - "traefik.http.routers.netbootxyz-rtr.middlewares=chain-oauth@file"
#       - "traefik.http.routers.vnetbootxyz-rtr.service=netbootxyz-svc"
#       - "traefik.http.services.netbootxyz-svc.loadbalancer.server.port=3000"

volumes:
  teslamate-grafana-data:
